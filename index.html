<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.8.dev">
<meta name="author" content="Servicio de las Tecnologías de la Información y las Comunicaciones - Universidad de Almería">
<title>Introducción a NestJS</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Introducción a NestJS</h1>
<div class="details">
<span id="author" class="author">Servicio de las Tecnologías de la Información y las Comunicaciones - Universidad de Almería</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#trueresumen">Resumen</a></li>
<li><a href="#trueintroducción">1. Introducción</a></li>
<li><a href="#truecreación-del-proyecto">2. Creación del proyecto</a>
<ul class="sectlevel2">
<li><a href="#truefuncionamiento-servicios-y-controladores">2.1. Funcionamiento (Servicios y Controladores)</a></li>
<li><a href="#truedefinir-un-prefijo-para-la-api">2.2. Definir un prefijo para la API.</a></li>
</ul>
</li>
<li><a href="#truecreación-de-nuestro-primer-servicio-y-controlador">3. Creación de nuestro primer servicio y controlador</a>
<ul class="sectlevel2">
<li><a href="#trueel-servicio">3.1. El servicio</a></li>
<li><a href="#trueel-controlador">3.2. El controlador</a></li>
</ul>
</li>
<li><a href="#truecreación-de-la-primera-versión-de-los-endpoints">4. Creación de la primera versión de los endpoints</a>
<ul class="sectlevel2">
<li><a href="#truerecuperación-de-un-libro">4.1. Recuperación de un libro</a></li>
<li><a href="#truefiltrado-mediante-parámetros-recuperación-de-todos-los-libros-en-orden-descendente">4.2. Filtrado mediante parámetros. Recuperación de todos los libros en orden descendente.</a></li>
<li><a href="#truecreación-de-un-libro">4.3. Creación de un libro</a></li>
<li><a href="#trueeliminación-de-un-libro">4.4. Eliminación de un libro</a></li>
<li><a href="#truemodificación-de-un-libro">4.5. Modificación de un libro</a></li>
</ul>
</li>
<li><a href="#truetipado-de-objetos">5. Tipado de objetos</a>
<ul class="sectlevel2">
<li><a href="#truecreación-de-una-interface-para-libros">5.1. Creación de una interface para libros</a></li>
<li><a href="#truecreación-de-un-dto-para-libros">5.2. Creación de un DTO para libros</a></li>
<li><a href="#truemodificación-del-controlador-para-el-uso-de-tipos">5.3. Modificación del controlador para el uso de tipos</a></li>
<li><a href="#truemodificación-del-servicio-para-el-uso-de-tipos">5.4. Modificación del servicio para el uso de tipos</a></li>
</ul>
</li>
<li><a href="#truefinalización-del-mockeado">6. Finalización del mockeado</a>
<ul class="sectlevel2">
<li><a href="#trueel-servicio-7">6.1. El servicio</a></li>
<li><a href="#trueel-controlador-7">6.2. El controlador</a></li>
</ul>
</li>
<li><a href="#truecreación-de-servicios-conectados-a-bases-de-datos">7. Creación de servicios conectados a bases de datos</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguración-de-un-servidor-mysql">7.1. Configuración de un servidor MySQL</a></li>
<li><a href="#trueorm-y-el-patrón-de-repositorio">7.2. ORM y el patrón de repositorio</a></li>
<li><a href="#trueconfiguración-de-la-conexión-a-la-base-de-datos">7.3. Configuración de la conexión a la base de datos</a></li>
<li><a href="#truecreación-de-entidades">7.4. Creación de entidades</a></li>
<li><a href="#trueel-servicio-8">7.5. El servicio</a></li>
<li><a href="#trueel-controlador-8">7.6. El controlador</a></li>
<li><a href="#truemódulo-para-una-mejor-organización">7.7. Módulo para una mejor organización</a></li>
<li><a href="#truemejora-de-la-configuración-del-uso-del-orm">7.8. Mejora de la configuración del uso del ORM</a></li>
<li><a href="#truepruebas-de-los-endpoints-con-persistencia-en-la-base-de-datos">7.9. Pruebas de los endpoints con persistencia en la base de datos</a></li>
<li><a href="#truecambio-a-un-servidor-postgresql">7.10. Cambio a un servidor PostgreSQL</a></li>
</ul>
</li>
<li><a href="#trueautenticación-con-json-web-tokens">8. Autenticación con JSON Web Tokens</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguración-de-la-estrategia-passport">8.1. Configuración de la estrategia Passport</a></li>
<li><a href="#truemódulo-de-autenticación">8.2. Módulo de autenticación</a></li>
<li><a href="#truerestricción-del-acceso-de-los-endpoints">8.3. Restricción del acceso de los endpoints</a></li>
</ul>
</li>
<li><a href="#truedocumentación-de-la-api-con-swagger-openapi">9. Documentación de la API con Swagger (OpenAPI)</a>
<ul class="sectlevel2">
<li><a href="#truedocumentación-de-dtos-entidades-clases-e-interfaces">9.1. Documentación de DTOs, entidades, clases e interfaces</a></li>
<li><a href="#truedocumentación-de-los-controladores">9.2. Documentación de los controladores</a></li>
<li><a href="#truedescarga-de-json">9.3. Descarga de JSON</a></li>
<li><a href="#truecambio-del-frontend">9.4. Cambio del frontend</a></li>
</ul>
</li>
<li><a href="#truelogging">10. Logging</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguración-de-winston">10.1. Configuración de Winston</a></li>
<li><a href="#trueregistro-de-logs-con-winston">10.2. Registro de logs con Winston</a></li>
<li><a href="#truelog-de-operaciones-de-la-api">10.3. Log de operaciones de la API</a></li>
</ul>
</li>
<li><a href="#truemejora-del-controlador-con-estados-http-estándar">11. Mejora del controlador con estados HTTP estándar</a></li>
<li><a href="#truedocumentación-del-código">12. Documentación del código</a></li>
<li><a href="#trueestado-de-salud">13. Estado de salud</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguración-inicial-del-estado-de-salud">13.1. Configuración inicial del estado de salud</a></li>
<li><a href="#trueestado-de-salud-de-componentes">13.2. Estado de salud de componentes</a></li>
</ul>
</li>
<li><a href="#trueactivación-de-métricas">14. Activación de métricas</a>
<ul class="sectlevel2">
<li><a href="#truemétricas-de-forma-manual">14.1. Métricas de forma manual</a></li>
<li><a href="#truemétricas-con-swagger-stats">14.2. Métricas con <code>swagger-stats</code></a></li>
</ul>
</li>
<li><a href="#trueapéndice-a-datos-de-ejemplo">Apéndice A. Datos de ejemplo</a></li>
<li><a href="#trueapéndice-b-generación-de-código">Apéndice B. Generación de código</a>
<ul class="sectlevel2">
<li><a href="#truegenerador-de-archivos-para-una-entidad">Generador de archivos para una entidad</a></li>
<li><a href="#truegenerador-del-código-de-la-entidad">Generador del código de la entidad</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/logocloudstic.png" alt="logocloudstic">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueresumen"><a class="anchor" href="#trueresumen"></a>Resumen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>NestJS es un framework para el desearrollo de aplicaciones Node.js en el lado del servidor. Se programa en TypeScript y proporciona una arquitectura en la aplicación que permite el desarrollo de aplicaciones más fáciles de mantener. Su arquitectura está bastante inspirada en Angular lo que facilita el trabajo al equipo de desarrollo al no tener que usar dos formas diferentes de trabajo en el backend y en el frontend.</p>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Usar el CLI de Nest para la creación de componentes de la aplicación</p>
</li>
<li>
<p>Conocer el funcionamiento de los controladores y los servicios</p>
</li>
<li>
<p>Crear los métodos básicos CRUD de una aplicación</p>
</li>
<li>
<p>Saber cómo capturar los parámetros de las peticiones HTTP</p>
</li>
<li>
<p>Conocer las diferencias y utilidades de las <em>entities</em> de los ORM (Object Relational Mappers), las interfaces y los DTO (Data Transfer Objects)</p>
</li>
<li>
<p>Crear una API sencilla con datos mockeados</p>
</li>
<li>
<p>Crear servicios basados en bases de datos</p>
</li>
<li>
<p>Usar JWT como mecanismo de control de acceso</p>
</li>
<li>
<p>Usar Swagger para la documentación de la API</p>
</li>
<li>
<p>Registrar las operaciones de la aplicación en archivos de log</p>
</li>
<li>
<p>Usar Compodoc para la documentación de la aplicación</p>
</li>
<li>
<p>Ofrecer la salud de la API en una ruta concreta</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Disponible el <a href="https://github.com/ualmtorres/tutorial-nest-js">repositorio</a> usado en este tutorial.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueintroducción"><a class="anchor" href="#trueintroducción"></a>1. Introducción</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A la hora de desarrollar un proyecto es importante tener una estructura y una estrategia bien planeada para la organización del código. En situaciones donde además los requerimientos son cambiantes es fácil llegar pronto al desastre. Uno de los motivos por los que surge el framework <a href="https://nestjs.com/">NestJS</a> es precisamente el facilitar que los desarrolladores puedan tener una estructura modular de código, lo que facilita el desarrollo de aplicaciones NodeJS empresariales.</p>
</div>
<div class="paragraph">
<p>NestJS es un framework NodeJS construido sobre NodeJS y TypeScript, y que hace uso de <a href="https://expressjs.com/es/">Express</a>. Además ofrece soporte para las principales bases de datos (MySQL, PostgreSQL, Oracle, SQLite, MongoDB, &#8230;&#8203;), <a href="https://swagger.io/">Swagger (OpenAPI)</a>, autenticación, logging, y una arquitectura inspirada en <a href="https://angular.io/">Angular</a>, características que lo hacen un framework bastante interesante.</p>
</div>
<div class="paragraph">
<p>En este tutorial desarrollaremos una API (<a href="https://github.com/ualmtorres/tutorial-nest-js">repositorio</a>) sobre bases de datos (MySQL y PostgreSQL) que implementa endpoints para las operaciones básicas (<code>find, findOne, create, update, delete</code>). Comenzaremos creando un armazón con los controladores y servicios funcionando en modo mock. Una vez probada la conexión correcta entre ellos, se sustituirán los servicios para que interactúen con la base de datos. Además, la API implementará control de acceso a los endpoints mediante <a href="https://jwt.io/">JSON Web Tokens</a>, quedará documentada con Swagger y registrará sus operaciones en archivos de log.</p>
</div>
<div class="paragraph">
<p>En cuanto a la información de uso de la API se ve cómo usar <code>Terminus</code> para exponer el estado de salud de la aplicación y sus componentes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreación-del-proyecto"><a class="anchor" href="#truecreación-del-proyecto"></a>2. Creación del proyecto</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ nest new tutorial-nest-js
$ cd tutorial-nest-js
$ npm run start:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto crea un proyecto y lo ejecuta en el puerto 3000 en modo <em>live reload</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/HelloWorld.png" alt="HelloWorld">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Se puede cambiar el puerto en el que se sirve la aplicación modificando el archivo <code>main.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">  await app.listen(3000); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cambiar por el puerto deseado</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="truefuncionamiento-servicios-y-controladores"><a class="anchor" href="#truefuncionamiento-servicios-y-controladores"></a>2.1. Funcionamiento (Servicios y Controladores)</h3>
<div class="paragraph">
<p>Los servicios se encargan de abstraer la complejidad y la lógica del negocio a una clase aparte. El CLI de NestJS añade el decorador <code>@Injectable</code> a los servicios durante su creación. Estos servicios se podrán inyectar en controladores o en otros servicios.</p>
</div>
<div class="paragraph">
<p>Archivo <code>app.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';

@Injectable() <i class="conum" data-value="1"></i><b>(1)</b>
export class AppService {
  getHello(): string { <i class="conum" data-value="2"></i><b>(2)</b>
    return 'Hello World!';
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador que permite que el servicio pueda ser inyectado en controladores y en otros servicios</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Función que proporciona una funcionalidad determinada</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El controlador se encarga por un lado de escuchar las peticiones que llegan a la aplicación. Por otro lado, se encarga de preparar las respuestas que proporciona la aplicación. El CLI de NestJS añade el decorador <code>@Controller</code> a los controladores durante su creación. NestJS permite el uso de rutas como parámetros del decorador <code>@Controller</code></p>
</div>
<div class="paragraph">
<p>Archivo <code>app.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service'; <i class="conum" data-value="1"></i><b>(1)</b>

@Controller() <i class="conum" data-value="2"></i><b>(2)</b>
export class AppController {
  constructor(private readonly appService: AppService) {} <i class="conum" data-value="3"></i><b>(3)</b>

  @Get() <i class="conum" data-value="4"></i><b>(4)</b>
  getHello(): string { <i class="conum" data-value="5"></i><b>(5)</b>
    return this.appService.getHello(); <i class="conum" data-value="6"></i><b>(6)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Decorador que indica a NestJS que es un controlador</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Inyección del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Tipo de petición HTTP y ruta (vacía) atendida por el controlador</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Función a ejecutar al tras invocar la ruta con una petición <code>GET</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Invocación al servicio que resuelve la petición</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truedefinir-un-prefijo-para-la-api"><a class="anchor" href="#truedefinir-un-prefijo-para-la-api"></a>2.2. Definir un prefijo para la API.</h3>
<div class="paragraph">
<p>Archivo <code>main.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.setGlobalPrefix('api/v1'); <i class="conum" data-value="1"></i><b>(1)</b>
  await app.listen(3000);
}
bootstrap();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Prefijo global</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La aplicación ahora deberá ser llamada incluyendo el prefijo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">http://localhost:3000/api/v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si no incluimos el prefijo y seguimos invocando a <code><a href="http://localhost:3000" class="bare">http://localhost:3000</a></code> obtenendremos el siguiente error. Este error indica que la aplicación no tiene nada que respponda en esa ruta a ese tipo de petición HTTP.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "statusCode": 404,
  "message": "Cannot GET /",
  "error": "Not Found"
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreación-de-nuestro-primer-servicio-y-controlador"><a class="anchor" href="#truecreación-de-nuestro-primer-servicio-y-controlador"></a>3. Creación de nuestro primer servicio y controlador</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Desde la línea de comandos usaremos el CLI de NestJS.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ nest g service books
$ nest g controller books</code></pre>
</div>
</div>
<div class="paragraph">
<p>El servicio creado está disponible en <code>books/books.service.ts</code> y el controlador creado está disponible en <code>books.controller.ts</code>. Los archivos <code>.spec.ts</code> son archivos para pruebas que no trataremos aquí.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El CLI de NestJS ha generado el archivo del servicio <code>books/books.service.ts</code> con el decorador <code>@Injectable</code> y el archivo del controlador <code>books.controller.ts</code> con el decorador <code>@Controller</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La creación del servicio y del controlador han modificado el archivo <code>app.module.ts</code> incorporándolos a la lista de servicios y controladores de la aplicación.</p>
</div>
<div class="paragraph">
<p>El archivo <code>app.module.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { BooksService } from './books/books.service';
import { BooksController } from './books/books.controller';

@Module({
  imports: [],
  controllers: [AppController, BooksController], <i class="conum" data-value="1"></i><b>(1)</b>
  providers: [AppService, BooksService], <i class="conum" data-value="2"></i><b>(2)</b>
})
export class AppModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Lista de controladores</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Lista de providers</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Los <em>providers</em> son un concepto de un nivel de abstracción mayor al de los servicios. Cuando decíamos que los servicios se encargaban de abstraer la complejidad y la lógica del negocio a una clase aparte, realmente se debía a que esta abstracción es propia de los <em>providers</em>. Al ser un servicio un tipo particular de <em>provider</em> simplemente heredan su comportamiento.</p>
</div>
<div class="paragraph">
<p>Un <em>provider</em> puede ser un servicio, pero también puede ser un repositorio, una factoría o un <em>helper</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="trueel-servicio"><a class="anchor" href="#trueel-servicio"></a>3.1. El servicio</h3>
<div class="paragraph">
<p>Implementamos las funciones que proporcionan los datos.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Es buena práctica comenzar desarrollando todas las funciones que necesitemos ofreciendo inicialmente la funcionalidad de mostrar simplemente que han sido llamadas. Posteriormente, le iremos añadiendo su lógica real de forma progresiva. Esto nos permite tener inicialmente los componentes y las llamadas funcionando e interactuando sin adentrarnos en la complejidad del dominio.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';

@Injectable()
export class BooksService {
  findAll(): any { <i class="conum" data-value="1"></i><b>(1)</b>
    return 'findAll funcionando';
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ejemplo de función que se limita a indicar que está funcionando cuando es llamada</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueel-controlador"><a class="anchor" href="#trueel-controlador"></a>3.2. El controlador</h3>
<div class="paragraph">
<p>Comenzamos añadiendo simplemente por ahora:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El constructor donde se inyecta el servicio para poder usarlo</p>
</li>
<li>
<p>Creando la primera ruta y el método HTTP asociado que vamos a probar</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Controller, Get } from '@nestjs/common';
import { BooksService } from './books.service'; <i class="conum" data-value="1"></i><b>(1)</b>

@Controller('books')
export class BooksController {
  constructor(private booksService: BooksService) {} <i class="conum" data-value="2"></i><b>(2)</b>

  @Get() <i class="conum" data-value="3"></i><b>(3)</b>
  findAll() { <i class="conum" data-value="4"></i><b>(4)</b>
    return this.booksService.findAll(); <i class="conum" data-value="5"></i><b>(5)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación del servicio que proporciona los datos</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Constructor con el servicio inyectado</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Decorador para indicar la ruta atendida y el método HTTP</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Método asociado a la petición</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Llamada al método del servicio que resuelve la petición</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora llamamos a <code><a href="http://localhost:3000/api/v1/books" class="bare">http://localhost:3000/api/v1/books</a></code>
el controlador interceptará la petición, usará el servicio y obtendremos la respuesta siguiente.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PrimerServicio.png" alt="PrimerServicio">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreación-de-la-primera-versión-de-los-endpoints"><a class="anchor" href="#truecreación-de-la-primera-versión-de-los-endpoints"></a>4. Creación de la primera versión de los endpoints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Comenzaremos haciendo el <em>armazón (scaffolfding)</em> de los endpoints para todas las rutas permitidas pero en una versión muy preliminar. Los servicios se limitarán a mostrar que han sido llamados y a mostrar los parámetros pasados. Una vez que todos funcionen correctamente podremos sustituirlos por servicios que tengan la respuesta real que exige el problema.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Endpoints</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Método</th>
<th class="tableblock halign-left valign-top">Endpoint</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/api/v1/books</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtener lista de libros</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/api/v1/books/{bookId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve información sobre un libro específico</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/api/v1/books</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crear un libro</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/api/v1/books/{bookId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eliminar un libro específico</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PUT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/api/v1/books/{bookId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modificar un libro específico</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="truerecuperación-de-un-libro"><a class="anchor" href="#truerecuperación-de-un-libro"></a>4.1. Recuperación de un libro</h3>
<div class="sect3">
<h4 id="trueel-servicio-2"><a class="anchor" href="#trueel-servicio-2"></a>4.1.1. El servicio</h4>
<div class="paragraph">
<p>Añadimos la función que implementa el servicio de recuperación de un libro específico. Tomará como argumento el <code>id</code> del libro e inicialmente se limitará a devolver un mensaje con el propio nombre de la función y el <code>id</code> pasado como argumento. Esto permite comprobar que la función ha sido llamada correctamente.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  findBook(bookId: string) {
    return `findBook funcionando con bookId: ${bookId}`;
  }
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueel-controlador-2"><a class="anchor" href="#trueel-controlador-2"></a>4.1.2. El controlador</h4>
<div class="paragraph">
<p>Añadimos la ruta que implementa la petición. Tomará como parámetro el <code>id</code> del libro (<code>bookId</code>). Usaremos el decorador NestJS <code>@Param</code> para obtener el parámetro de la petición.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Param } from '@nestjs/common';
...
@Controller('books')
export class BooksController {
...
  @Get(':bookId') <i class="conum" data-value="1"></i><b>(1)</b>
  findBook(@Param('bookId') bookId: string) { <i class="conum" data-value="2"></i><b>(2)</b>
    return this.booksService.findBook(bookId); <i class="conum" data-value="3"></i><b>(3)</b>
  }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>bookId</code> es el nombre que se le da al argumento en la petición</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Método asociado a la petición con referencia al argumento de la petición y variable asociada para el método</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Llamada al método del servicio que resuelve la petición</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Normalmente se usa el mismo nombre para el parámetro HTTP que para la variable que lo maneja en el método. Sin embargo, son dos objetos diferentes. A continuación se muestra con quien empareja cada uno.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">  @Get(':RequestedBookId')
  findBook(@Param('RequestedBookId') methodBookId: string) {
    return this.booksService.findBook(methodBookId);
  }</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora llamamos a <code><a href="http://localhost:3000/api/v1/books/1" class="bare">http://localhost:3000/api/v1/books/1</a></code> el controlador interceptará la petición, asignará <code>1</code> al parámetro <code>bookId</code> y obtendremos la respuesta siguiente.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/GetBookV0.png" alt="GetBookV0">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truefiltrado-mediante-parámetros-recuperación-de-todos-los-libros-en-orden-descendente"><a class="anchor" href="#truefiltrado-mediante-parámetros-recuperación-de-todos-los-libros-en-orden-descendente"></a>4.2. Filtrado mediante parámetros. Recuperación de todos los libros en orden descendente.</h3>
<div class="paragraph">
<p>En la URL se pueden pasar parámetros en forma de una lista de pares clave valor. Por ejemplo: <code><a href="http://localhost:3000/api/v1/books?sort=1" class="bare">http://localhost:3000/api/v1/books?sort=1</a></code>. Los parámetros son recogidos en NestJS con el decorador <code>@Query()</code></p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Nuevo endpoint o sólo parametros</div>
<div class="paragraph">
<p>Puede surgir la duda de si la recuperación de libros de forma ordenada es un nuevo endpoint o se trata de añadir parámetros a un endpoint existente. Es decir, se trata de elegir entre estas dos alternativas:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code><a href="http://localhost:3000/api/v1/books/sort/1" class="bare">http://localhost:3000/api/v1/books/sort/1</a></code></p>
</li>
<li>
<p><code><a href="http://localhost:3000/api/v1/books?sort=1" class="bare">http://localhost:3000/api/v1/books?sort=1</a></code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Para resolver la duda nos debemos plantear si la estructura de los datos devueltos cambia de un caso a otro o es la misma en los dos casos. Si cambia estaríamos ante un nuevo endpoint. En cambio, si es la misma, estaríamos ante parámetros.</p>
</div>
<div class="paragraph">
<p>En este caso, la ordenación sigue presentando los datos siguiendo la misma estructura. Es decir, sigue siendo una lista de libros igualmente. Lo único es que se presenta ordenada. El servicio tendrá que capturar los parámetros y devolver los datos de acuerdo a la petición realizada.</p>
</div>
<div class="paragraph">
<p>Esta misma solución es aplicable si hay varios parámetros. Por ejemplo, ordenación, limitación de cantidad de resultados, offsets, filtrado por algún campo, etc. En todos estos casos se sigue devolviendo una lista de resultados con la misma estructura (p.e. libros).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La alternativa de uso de parámetros reduce la cantidad de endpoints a tratar y permite que los parámetros sean opcionales.
El servicio tendrá que encargarse de determinar cómo trabajar con los parámetros de la petición.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Como la petición de recuperación de libros de forma ordenada sigue devolviendo una lista de libros con la misma estructura, optamos por implementar esta funcionalidad mediante parámetros, trasladando la lógica de su interptretación al servicio.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueel-servicio-3"><a class="anchor" href="#trueel-servicio-3"></a>4.2.1. El servicio</h4>
<div class="paragraph">
<p>La versión preliminar del servicio parametrizado modificará el servicio existente de recuperación de libros. La función tomará los argumentos y se limitará a devolver un mensaje con el propio nombre de la función y el argumento (si existe). Esto permite comprobar que la función ha sido llamada correctamente.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  findAll(params): any {
    return params.length &gt; 0
      ? `findAll funcionando con ${params}`
      : 'findAll funcionando';
  }
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueel-controlador-3"><a class="anchor" href="#trueel-controlador-3"></a>4.2.2. El controlador</h4>
<div class="paragraph">
<p>Modificamos la ruta que implementa la petición. Tomará como parámetro el tipo de ordenación. Usaremos el decorador NestJS @Query para obtener el parámetro de la petición.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Query } from '@nestjs/common';
...
  @Get()
  findAll(@Query('order') order: string) { <i class="conum" data-value="1"></i><b>(1)</b>
    let params = []; <i class="conum" data-value="2"></i><b>(2)</b>

    if (order !== undefined) {
       params.push(`'${order}'`); <i class="conum" data-value="3"></i><b>(3)</b>
    }

    return this.booksService.findAll(params); <i class="conum" data-value="4"></i><b>(4)</b>
  }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Captura del parámetro <code>order</code> en una variable <code>order</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Array para almacenamiento de parámetros</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Si se ha pasado el parámetro en la petición, se introduce en el array de parámetros</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Llamada al servicio con los parámetros leídos</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="trueuna-solución-más-dinámica"><a class="anchor" href="#trueuna-solución-más-dinámica"></a>4.2.3. Una solución más dinámica</h4>
<div class="paragraph">
<p>La solución planteada para el uso de parámetros hace que ante nuevos parámetros en las peticiones se tenga que modificar tanto el controlador (añadiendo nuevos decoradores <code>@Query</code> para los nuevos parámetros) como el servicio, que es el que hace uso de ellos.</p>
</div>
<div class="paragraph">
<p>El decorador <code>@Req</code> nos permite acceder a todos los datos de una petición. En nuestro caso estamos interesados en acceder a <code>query</code>. Esta <code>query</code> contiene un JSON con los pares parámetro-valor pasados en la petición. La idea es pasar directamente este JSON al servicio y que sea el servicio en que se encargue de acceder a su contenido y actuar como corresponda.</p>
</div>
<div class="paragraph">
<p>El servicio <code>books/book.service.ts</code> adaptado para un nuevo parámetro (<code>limit</code>) quedaría así.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  findAll(params): any {
    let msg = `findAll funcionando. Parámetros:`;

    if (params.order !== undefined) {
      msg = msg + ` order: ${params.order}`;
    }

    if (params.limit !== undefined) {
      msg = msg + ` limit: ${params.limit}`;
    }

    return msg;
  }
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>El controdor <code>books/book.controller.ts</code> ahora quedaría así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Req } from '@nestjs/common';
import { BooksService } from './books.service';
import { Request } from 'express';
...

@Controller('books')
export class BooksController {
  constructor(private booksService: BooksService) {}

  @Get()
  findAll(@Req() request: Request) { <i class="conum" data-value="1"></i><b>(1)</b>
    return this.booksService.findAll(request.query); <i class="conum" data-value="2"></i><b>(2)</b>
  }
...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inyección del objeto <code>request</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Llamada al servicio con el JSON con los pares clave-valor de los parámetros de la petición</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si hiciéramos la petición <code><a href="http://localhost:3000/api/v1/books?order=1&amp;limit=10" class="bare">http://localhost:3000/api/v1/books?order=1&amp;limit=10</a></code>, <code>request.query</code> contendría lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{ order: '1', limit: '10' }</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La pantalla siguiente muestra el resultado de realizar la petición con dos parámetros <code>order</code> y <code>limit</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ParametrosDinamicos.png" alt="ParametrosDinamicos">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-de-un-libro"><a class="anchor" href="#truecreación-de-un-libro"></a>4.3. Creación de un libro</h3>
<div class="paragraph">
<p>Los objetos a crear se pasarán en el <code>body</code> de la petición en formato JSON. El cuerpo de la respuesta contedrá el objeto creado.</p>
</div>
<div class="paragraph">
<p>Supongamos que deseamos insertar el libro siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "title": "El enigma de la habitación 622",
    "genre": "Ficción contemporánea",
    "description": "Vuelve el «principito de la literatura negra contemporánea, el niño mimado de la industria literaria» (GQ): el nuevo thriller de Joël Dicker es su novela más personal. ",
    "author": "Joël Dicker",
    "publisher": "Alfaguara",
    "pages": 624,
    "image_url": "https://images-na.ssl-images-amazon.com/images/I/41KiZbwOhhL._SX315_BO1,204,203,200_.jpg"
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="trueel-servicio-4"><a class="anchor" href="#trueel-servicio-4"></a>4.3.1. El servicio</h4>
<div class="paragraph">
<p>La versión preliminar del servicio para crear un nuevo libro se limitará a devolver el libro que le llega como parámetro. Esto permite comprobar que la función ha sido llamada correctamente.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  createBook(newBook: any) {
    return newBook;
  }
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueel-controlador-4"><a class="anchor" href="#trueel-controlador-4"></a>4.3.2. El controlador</h4>
<div class="paragraph">
<p>El decorador @Body nos permite acceder al <code>body</code> enviado en una petición.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Post,
  Body,
} from '@nestjs/common';
import { BooksService } from './books.service';
...

@Controller('books')
export class BooksController {
  constructor(private booksService: BooksService) {}
...
  @Post() <i class="conum" data-value="1"></i><b>(1)</b>
  createBook(@Body() body) { <i class="conum" data-value="2"></i><b>(2)</b>
    let newBook: any = body; <i class="conum" data-value="3"></i><b>(3)</b>
    return this.booksService.createBook(newBook); <i class="conum" data-value="4"></i><b>(4)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador para el método Post</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Decorador para el objeto <code>body</code>. Los datos pasados para el nuevo libro se tratan en la variable <code>body</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creación de un nuevo objeto para poder tratar los datos recibidos</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Llamada al servicio de creación de libros con el libro recibido</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La figura siguiente muestra el resultado de la operación <code>POST</code> con el nuevo libro y la respuesta obtenida.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PostBook.png" alt="PostBook">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueeliminación-de-un-libro"><a class="anchor" href="#trueeliminación-de-un-libro"></a>4.4. Eliminación de un libro</h3>
<div class="paragraph">
<p>La eliminación es muy similar a la de búsqueda de un elemento por <code>id</code>. Se intercepta el <code>id</code> de la ruta y se llama al servicio.</p>
</div>
<div class="sect3">
<h4 id="trueel-servicio-5"><a class="anchor" href="#trueel-servicio-5"></a>4.4.1. El servicio</h4>
<div class="paragraph">
<p>Añadimos la función que implementa el servicio de eliminación de un libro. Se trata de una función muy similar a la de buscar un libro. Tomará como argumento el <code>id</code> del libro e inicialmente se limitará a devolver un mensaje con el nombre de la función y el id pasado como argumento. Esto permite comprobar que la función ha sido llamada correctamente.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  deleteBook(bookId: string) {
    return `deleteBook funcionando con bookId: ${bookId}`;
  }
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueel-controlador-5"><a class="anchor" href="#trueel-controlador-5"></a>4.4.2. El controlador</h4>
<div class="paragraph">
<p>Añadimos la ruta que implementa la petición. Tomará como parámetro el <code>id</code> del libro (<code>bookId</code>). Usaremos el decorador NestJS <code>@Delete</code></p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
@Controller('books')
export class BooksController {
...
  @Delete(':bookId') <i class="conum" data-value="1"></i><b>(1)</b>
  deleteBook(@Param('bookId') bookId: string) { <i class="conum" data-value="2"></i><b>(2)</b>
    return this.booksService.deleteBook(bookId); <i class="conum" data-value="3"></i><b>(3)</b>
  }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>bookId</code> es el nombre que se le da al argumento en la petición</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Método asociado a la petición con referencia al argumento de la petición y variable asociada para el método</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Llamada al método del servicio que resuelve la petición</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora hacemos un <code>DELETE</code> contra <code><a href="http://localhost:3000/api/v1/books/1" class="bare">http://localhost:3000/api/v1/books/1</a></code> el controlador interceptará la petición, asignará <code>1</code> al parámetro <code>bookId</code> y obtendremos la respuesta siguiente.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/DeleteBookV0.png" alt="DeleteBookV0">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truemodificación-de-un-libro"><a class="anchor" href="#truemodificación-de-un-libro"></a>4.5. Modificación de un libro</h3>
<div class="paragraph">
<p>La modificación se puede ver como una operación que combina búsqueda y paso del <code>body</code> con los datos a actualizar. Se intercepta el <code>id</code> de la ruta el <code>body</code>  de la petición.</p>
</div>
<div class="sect3">
<h4 id="trueel-servicio-6"><a class="anchor" href="#trueel-servicio-6"></a>4.5.1. El servicio</h4>
<div class="paragraph">
<p>Añadimos la función que implementa el servicio de modificación de un libro. Tomará como argumentos el <code>id</code> del libro y los nuevos datos del libro. Inicialmente devolverá los datos del libro modificado. Esto permite comprobar que la función ha sido llamada correctamente.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  updateBook(bookId: string, newBook: any) {
    return newBook;
  }
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueel-controlador-6"><a class="anchor" href="#trueel-controlador-6"></a>4.5.2. El controlador</h4>
<div class="paragraph">
<p>Añadimos la ruta que implementa la petición. Tomará como parámetro el <code>id</code> del libro (<code>bookId</code>). Usaremos el decorador NestJS <code>@Put</code></p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
@Controller('books')
export class BooksController {
...
  @Put(':bookId') <i class="conum" data-value="1"></i><b>(1)</b>
  updateBook(@Param('bookId') bookId: string, @Body() body) { <i class="conum" data-value="2"></i><b>(2)</b>
    let newBook: any = body;
    return this.booksService.updateBook(bookId, newBook); <i class="conum" data-value="3"></i><b>(3)</b>
  }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>bookId</code> es el nombre que se le da al argumento en la petición</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Método asociado a la petición con referencia al argumento de la petición, variables asociada para el método y cuerpo con los nuevos datos del libro</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Llamada al método del servicio que resuelve la petición</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora hacemos un <code>UPDATE</code> contra <code><a href="http://localhost:3000/api/v1/books/1" class="bare">http://localhost:3000/api/v1/books/1</a></code> y le pasamos en el <code>body</code> el JSON con los nuevos datos del libro, el controlador interceptará la petición, asignará <code>1</code> al parámetro <code>bookId</code>, pasará el cuerpo, el controlador los pasará al servicio y obtendremos la respuesta siguiente con los nuevos datos del libro.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PutBookV0.png" alt="PutBookV0">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truetipado-de-objetos"><a class="anchor" href="#truetipado-de-objetos"></a>5. Tipado de objetos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora hemos tratados con el objeto libro, con el <code>body</code> de las peticiones que hacen <code>POST</code> o <code>PUT</code> y en ninguna hemos indicado un tipo de datos. Su tipo queda entonces como <code>any</code>. Sin embargo, esto no es una buena práctica. El uso de tipos nos permitirá durante el desarrollo determinar las propiedades aplicables a un objeto, la estructura que tienen que tener los objetos de las peticiones, y demás.</p>
</div>
<div class="paragraph">
<p>En este tutorial vamos a ver distintos tipos aplicables a los objetos. Para favorecer su comprensión seguimos con el ejemplo de los libros y suponemos que vamos a usar una base de datos para persistir los datos. En este caso tendríamos lo siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En la capa de base de datos los libros se podría modelar como una tabla en una base de datos relacional, como una colección en una base de datos de documentos,</p>
</li>
<li>
<p>Las <strong>entities</strong>. Si decidimos usar un <a href="https://es.wikipedia.org/wiki/Mapeo_objeto-relacional">ORM</a>, <a href="https://www.quora.com/What-is-Object-Document-Mapping">ODM</a> o similar, necesitaremos crear un objeto <code>entity</code> que represente la estructura de lo que se almacena en la base de datos. En nuestro caso, el objeto <code>entity</code> para libro podría tener las mismas propiedades que el objeto de la base de datos. Los objetos <code>entity</code> son los que se almacenan y se leen de la base de datos.</p>
</li>
<li>
<p>Las <strong>interfaces</strong>. En el nivel de desarrollo necesitamos manipular las propiedades de un objeto para no hacer referencia a propiedades inexistentes, evitar errores de tipado al trabajar con las propiedades de los objetos, y demás. Para ello, necesitaremos tener un <em>tipo</em> que represente a los objetos del negocio desde el punto de la programación. Estos tipos no tienen por que ser sustituidos por los tipos anteriores de los ORM/ODM, ya que nuestra aplicación puede que no usase ORM/ODM y no por ello dejarían de ser necesarios los tipos. Los tipos en este nivel los denominamos interfaces.</p>
</li>
<li>
<p>Los <strong>DTO (Data Transfer Objects)</strong>. Por último, hemos visto que las peticiones envían sus datos para que sean procesados por los servicios. Sin embargo, los datos enviados en las peticiones no tienen por que tener la misma estructura que las interfaces o que las <em>entities</em> definidas. Por ejemplo, en la petición para crear un libro puede que no se envíe el <code>id</code> del libro a crear porque se trata de un valor generado por el sistema. Por tanto, el tipo usado en la petición podría no coincidir con alguno de los tipos anteriores (<em>entities</em>,  DTO). Estaríamos hablando de un tipo exclusivo para la creación de libros (el tipo que contiene las propiedades que se pasan para crear un libro). Además, operaciones diferentes podrían usar tipos diferentes. Un caso sería que las modificaciones no permitiesen modificar todos los campos de un libro. Estaríamos ante un nuevo tipo, el tipo de los objetos a modificar. A este tipo de objetos se les denomina DTO. (Es habitual usar <code>CreateBookDTO</code>, <code>UpdateBookDTO</code> para representar los tipos de los datos pasados al crear y actualizar libros si los tipos son diferentes)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="truecreación-de-una-interface-para-libros"><a class="anchor" href="#truecreación-de-una-interface-para-libros"></a>5.1. Creación de una interface para libros</h3>
<div class="paragraph">
<p>Se define una interface con las propiedades que representan a un libro. En nuestro caso crearíamos un archivo <code>book.class.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">export class Book {
  id: number;
  title: string;
  genre: string;
  description: string;
  author: string;
  publisher: string;
  pages: number;
  image_url: string;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Definimos una clase en un lugar de una interface para poder instannciarla y simplificar el mockeado.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-de-un-dto-para-libros"><a class="anchor" href="#truecreación-de-un-dto-para-libros"></a>5.2. Creación de un DTO para libros</h3>
<div class="paragraph">
<p>Se define una clase <code>BookDto</code> que representa a las propiedades de un libro que se especifican y se envían cuando se realiza una petición para crear un libro. Hablamos de los datos que van en la petición y no tienen por que tener una correspondencia directa con un objeto completo del dominio. Incluso pueden contener propiedades de varios objetos del dominio. Como su nombre indica, los DTO (Data Transfer Object) representan a la estructura o al tipo de los datos que se están intercambiando.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">export class BookDto {
  readonly title: string;
  readonly genre: string;
  readonly description: string;
  readonly author: string;
  readonly publisher: string;
  readonly pages: number;
  readonly image_url: string;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El DTO de los libros no contiene el <code>id</code> del libro. Esto se debe a que es una propiedad que los usuarios no envían en sus peticiones.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truemodificación-del-controlador-para-el-uso-de-tipos"><a class="anchor" href="#truemodificación-del-controlador-para-el-uso-de-tipos"></a>5.3. Modificación del controlador para el uso de tipos</h3>
<div class="paragraph">
<p>Archivo <code>books/book.dto.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="typescript" class="language-typescript hljs">...
import { BookDto } from './book.dto'; <i class="conum" data-value="1"></i><b>(1)</b>

@Controller('books')
export class BooksController {
...

  @Post()
  createBook(@Body() newBook: BookDto) { <i class="conum" data-value="2"></i><b>(2)</b>
    return this.booksService.createBook(newBook); <i class="conum" data-value="3"></i><b>(3)</b>
  }

....

  @Put(':bookId')
  updateBook(@Param('bookId') bookId: string, @Body() newBook: BookDto) { <i class="conum" data-value="4"></i><b>(4)</b>
    return this.booksService.updateBook(bookId, newBook); <i class="conum" data-value="5"></i><b>(5)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>DTO de libro</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Emparejamiento de lo recibido en el <code>body</code> de un <code>POST</code> al tipo <code>BookDto</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Llamada al servicio de creación de libros con el libro ya tipado</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Emparejamiento de lo recibido en el <code>body</code> de un <code>PUT</code> al tipo <code>BookDto</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Llamada al servicio de actualización de libros con el libro ya tipado</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En este ejemplo se observa que se los objetos nuevos y los objetos modificados tienen el mismo tipo. Es decir, cuando se pasa un objeto a modificar, en el <code>body</code> se pasa el libro sin <code>id</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Este tipado permite manipular de forma segura las propiedades de los libros ayudando a detectarse errores derivados de asignación de valores a tipos incorrectos.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Uno o varios DTO</div>
<div class="paragraph">
<p>Un objeto puede tener DTO diferentes para operaciones diferentes. Por ejemplo, si decidiéramos que el DTO de un libro nuevo no contuviese el <code>id</code>, pero el DTO de un libro a modificar sí lo contuviese, tendríamos un caso de DTOs diferentes (p.e. <code>CreateBook.dto.ts</code> y <code>UpdateBook.dto.ts</code>)</p>
</div>
<div class="paragraph">
<p>Archivo <code>CreateBook.dto.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">export class CreateBookDto {
  readonly title: string;
  readonly genre: string;
  readonly description: string;
  readonly author: string;
  readonly publisher: string;
  readonly pages: number;
  readonly image_url: string;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Archivo <code>UpdateBook.dto.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">export class UpdateBookDto {
  readonly id: number; <i class="conum" data-value="1"></i><b>(1)</b>
  readonly title: string;
  readonly genre: string;
  readonly description: string;
  readonly author: string;
  readonly publisher: string;
  readonly pages: number;
  readonly image_url: string;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>DTO de un libro para modificar que sí lleva el <code>id</code> del libro modificado</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truemodificación-del-servicio-para-el-uso-de-tipos"><a class="anchor" href="#truemodificación-del-servicio-para-el-uso-de-tipos"></a>5.4. Modificación del servicio para el uso de tipos</h3>
<div class="paragraph">
<p>Archivo <code>books/book.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { BookDto } from './book.dto'; <i class="conum" data-value="1"></i><b>(1)</b>

@Injectable()
export class BooksService {
...
  createBook(newBook: BookDto) { <i class="conum" data-value="2"></i><b>(2)</b>
    return newBook;
  }

...

  updateBook(bookId: string, newBook: BookDto) { <i class="conum" data-value="3"></i><b>(3)</b>
    return newBook;
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>DTO de libro</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Libro tipado al DTO</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Libro tipado al DTO</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Este tipado permite manipular de forma segura las propiedades de los libros ayudando a detectarse errores derivados de asignación de valores a tipos incorrectos.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truefinalización-del-mockeado"><a class="anchor" href="#truefinalización-del-mockeado"></a>6. Finalización del mockeado</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora, las únicas operaciones que estaban mockeadas con objetos del dominio eran las operaciones de creación y de modificación. Las operaciones de consulta y eliminación se limitabana a devolver un texto indicando que se había alcanzado el endpoint. En este apartado, haremos que todas las operaciones trabajen con datos del dominio aunque todavía será algo preliminar, ya que serán sólo un par de libros almacenados en el propio código y ninguna operación tratará con datos reales (p.e. la búsqueda de un libro siempre devolverá el mismo libro, la actualización/eliminación siempre informará que se ha modificado/eliminado el mismo libro). No obstante, esto permite que el controlador ya trate con los tipos de datos que devolverán los servicios cuando implementen su funcionalidad real.</p>
</div>
<div class="sect2">
<h3 id="trueel-servicio-7"><a class="anchor" href="#trueel-servicio-7"></a>6.1. El servicio</h3>
<div class="paragraph">
<p>El archivo <code>books/boo.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable, HttpStatus, HttpException } from '@nestjs/common';
import { BookDto } from './book.dto'; <i class="conum" data-value="1"></i><b>(1)</b>
import { Book } from './book.class'; <i class="conum" data-value="2"></i><b>(2)</b>

@Injectable()
export class BooksService {
  books: Book[] = [ <i class="conum" data-value="3"></i><b>(3)</b>
    {
      id: 1,
      title: 'Una historia de España',
      genre: 'Historia',
      description:
        'Un relato ameno, personal, a ratos irónico, pero siempre único, de nuestra accidentada historia a través de los siglos. Una obra concebida por el autor para, en palabras suyas, «divertirme, releer y disfrutar; un pretexto para mirar atrás desde los tiempos remotos hasta el presente, reflexionar un poco sobre ello y contarlo por escrito de una manera poco ortodoxa.',
      author: 'Arturo Pérez-Reverte',
      publisher: 'Alfaguara',
      pages: 256,
      image_url:
        'https://images-na.ssl-images-amazon.com/images/I/41%2B-e981m1L._SX311_BO1,204,203,200_.jpg',
    },
    {
      id: 2,
      title: 'Historia de España contada para escépticos',
      genre: 'Historia',
      description:
        'Como escribe el autor, no pretende ser veraz, justa y desapasionada, porque ninguna historia lo es. No está hecha para halagar a reyes y gobernantes, ni pretende halagar a los banqueros, ni a la Conferencia Episcopal, ni al colectivo gay.',
      author: 'Juan Eslava Galán',
      publisher: 'Booket',
      pages: 592,
      image_url:
        'https://images-na.ssl-images-amazon.com/images/I/51IyZ5Mq8YL._SX326_BO1,204,203,200_.jpg',
    },
  ];
  findAll(params): Book[] { <i class="conum" data-value="4"></i><b>(4)</b>
    return this.books;
  }

  findBook(bookId: string): Book { <i class="conum" data-value="5"></i><b>(5)</b>
    return this.books[parseInt(bookId) - 1];
  }

  createBook(newBook: BookDto): Book { <i class="conum" data-value="6"></i><b>(6)</b>
    let book = new Book();

    book.id = 99;
    book.author = newBook.author;
    book.description = newBook.description;
    book.genre = newBook.genre;
    book.image_url = newBook.image_url;
    book.pages = newBook.pages;
    book.publisher = newBook.publisher;
    book.title = newBook.title;

    return book;
  }

  deleteBook(bookId: string): Book { <i class="conum" data-value="7"></i><b>(7)</b>
    return this.books[parseInt(bookId) - 1];
  }

  updateBook(bookId: string, newBook: BookDto): Book { <i class="conum" data-value="8"></i><b>(8)</b>
    return this.books[parseInt(bookId) - 1];
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>DTO del libro (no contiene el <code>id</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Interface del libro (contiene el <code>id</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Lista de libros de ejemplo mientras se desarrolla el acceso a BD del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>El método devuelve un array de <code>Book</code> con todos los libros</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>El método devuelve un <code>Book</code>, que contiene el <code>id</code>. Devuelve un libro a modo de ejemplo</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>El método toma un <code>BookDto</code> como argumento (libro sin <code>id</code>) y devuelve un libro completo (con el <code>id</code>). Devuelve el libro insertado</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>El método devuelve un <code>Book</code>, que contiene el <code>id</code>. Devuelve un libro a eliminado modo de ejemplo</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>El método toma un <code>BookDto</code> como argumento (libro sin <code>id</code>) y devuelve un <code>Book</code>, que sí contiene el <code>id</code>. Devuelve un libro modificado a modo de ejemplo</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueel-controlador-7"><a class="anchor" href="#trueel-controlador-7"></a>6.2. El controlador</h3>
<div class="paragraph">
<p>Se trata de usar los tipos que usan los parámetros de las funciones en las peticiones y de los tipos que devuelven.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/books.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Controller,
  Get,
  Param,
  Req,
  Post,
  Body,
  Delete,
  Put,
} from '@nestjs/common';
import { BooksService } from './books.service';
import { Request } from 'express';
import { BookDto } from './book.dto';
import { Book } from './book.class';

export class BooksController {
  constructor(private booksService: BooksService) {}

  findAll(@Req() request: Request): Book[] {
    console.log(request.query);
    return this.booksService.findAll(request.query);
  }

  findBook(@Param('bookId') bookId: string): Book {
    return this.booksService.findBook(bookId);
  }

  createBook(@Body() newBook: BookDto): Book {
    return this.booksService.createBook(newBook);
  }

  deleteBook(@Param('bookId') bookId: string): Book {
    return this.booksService.deleteBook(bookId);
  }

  updateBook(@Param('bookId') bookId: string, @Body() newBook: BookDto): Book {
    return this.booksService.updateBook(bookId, newBook);
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreación-de-servicios-conectados-a-bases-de-datos"><a class="anchor" href="#truecreación-de-servicios-conectados-a-bases-de-datos"></a>7. Creación de servicios conectados a bases de datos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora, los servicios que hemos creado en este tutorial se limitan a proporcionar unos datos de prueba generando una salida por la consola. Su cometido se ha estado limitando a comprobar que son alcanzables desde los endpoints definidos en la API, mostrándonos simplemente el eco de su llamada. En este apartado vamos a ver cómo conectar el servicio a bases de datos. Primero lo haremos conectando los servicios a una base de datos MySQL y luego comprobaremos lo fácil que es pasarlo a una base de datos PostgreSQL.</p>
</div>
<div class="sect2">
<h3 id="trueconfiguración-de-un-servidor-mysql"><a class="anchor" href="#trueconfiguración-de-un-servidor-mysql"></a>7.1. Configuración de un servidor MySQL</h3>
<div class="paragraph">
<p>Para trabajar localmente con persistencia necesitamos una base de datos a la que conectarnos. Para no tener que complicarnos con instalaciones y no acoplar el desarrollo a nuestro equipo utilizaremos una <a href="https://hub.docker.com/_/mysql">imagen Docker de MySQL 5.7</a>. Crearemos una base de datos denominada <code>tutorial</code>. Usaremos las cuenta <code>root</code> con el password <code>secret</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ docker run --name tutorial_mysql -e MYSQL_ROOT_PASSWORD=secret -p 3306:3306 -d mysql:5.7 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Usaremos el password <code>secret</code> para la cuenta <code>root</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras unos instantes (algo más si la imagen de MySQL 5.7 no está descargada en el equipo) habrá un contenedor en ejecución con el nombre <code>tutorial_mysql</code>. Iniciaremos una sesión interactiva para crear una base de datos, a la que denominaremos <code>tutorial</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ docker exec -it tutorial_mysql bash
root@d0512407a21d:/# mysql -u root -p
Enter password: <i class="conum" data-value="1"></i><b>(1)</b>
...
Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt;
mysql&gt; create database tutorial; <i class="conum" data-value="2"></i><b>(2)</b>
Query OK, 1 row affected (0.00 sec)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Introducir el password <code>secret</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Crear la base de datos <code>tutorial</code></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueorm-y-el-patrón-de-repositorio"><a class="anchor" href="#trueorm-y-el-patrón-de-repositorio"></a>7.2. ORM y el patrón de repositorio</h3>
<div class="paragraph">
<p>Un ORM nos abstrae del acceso a un gestor de bases de datos específico. Esto nos aisla del gestor de base de datos elegido y hace que podamos cambiar de gestor de bases de datos de forma muy sencilla. <a href="https://typeorm.io/#/">TypeORM</a> es un ORM para TypeScript y JavaScript que facilita la interacción con la base de datos. El uso de TypeORM acelera el proceso de desarrollo modelando entidades en el código y sincronizando estos modelos con la base de datos. Actualmente TypeORM ofrece soporte para varias bases de datos relacionales, como PostgreSQL, Oracle, Microsoft SQL Server, SQLite, e incluso para bases de datos NoSQL, como MongoDB.</p>
</div>
<div class="paragraph">
<p>Por otro lado, el <a href="http://blog.sapiensworks.com/post/2012/02/22/The-Repository-Pattern-Explained.aspx">patrón de repositorio</a> nos abstrae de los detalles de la persistencia proporcionando métodos abstractos para las operaciones comunes (crear, guardar, buscar, buscar una, actualizar, eliminar, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Resumiendo, el ORM trabaja con objetos de la base de datos y el repositorio trabaja con objetos del dominio.</p>
</div>
<div class="paragraph">
<p>Instalaremos los paquetes de TypeORM en el proyecto con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm install --save @nestjs/typeorm typeorm mysql</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-de-la-conexión-a-la-base-de-datos"><a class="anchor" href="#trueconfiguración-de-la-conexión-a-la-base-de-datos"></a>7.3. Configuración de la conexión a la base de datos</h3>
<div class="paragraph">
<p>Haremos la configuración de la base de datos en el archivo <code>app.module.ts</code> mediante <code>TypeOrmModule.forRoot()</code>. Se le pueden pasar los parámetros de configuración directamente. Sin embargo, existe otra opción que consiste en definir la configuración en un archivo <code>ormconfig.json</code>, que es el que de forma predeterminada busca TypeORM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { TypeOrmModule } from '@nestjs/typeorm';
...
@Module({
  imports: [
    TypeOrmModule.forRoot(), <i class="conum" data-value="1"></i><b>(1)</b>
    ...
  ],
  ....
})
export class AppModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>De forma predeterminada, si no se pasa ningún argumento se buscan los valores en <code>ormconfig.json</code> en la raíz del proyecto.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación se muestra el archivo <code>ormconfig.json</code>. Este archivo se almacena en la raíz del proyecto, junto al <code>package.json</code>.</p>
</div>
<div class="paragraph">
<p>Archivo <code>ormconfig,json</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "type": "mysql",
  "host": "localhost",
  "port": 3306,
  "username": "root",
  "password": "secret",
  "database": "tutorial",
  "entities": ["dist/**/*.entity.js"], <i class="conum" data-value="1"></i><b>(1)</b>
  "synchronize": true <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Dónde localizar los archivos de las entidades</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Sincronización automática de la base de datos con las entidades</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Configuración de los datos de conexión en el propio código</div>
<div class="paragraph">
<p>También se puede encontrar que los parámetros de conexión son colocados directamente como argumentos de <code>TypeOrmModule.forRoot()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="code" class="language-code hljs">...
    TypeOrmModule.forRoot(
      {
      type: 'mysql',
      host: 'localhost',
      port: 3306,
      username: 'root',
      password: 'example',
      database: 'my_nestjs_project',
      entities: ['dist/**/*.entity.js'],
      synchronize: true,
      }
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>El problema de este enfoque está en que las credenciales se adjuntarán en los commits que se hagan de este archivo. En cambio, si almacenamos las credenciales en un archivo <code>ormconfig.json</code> y lo incluimos en el archivo <code>.gitignore</code>, los datos sensibles almacenados en <code>ormconfig.json</code> no serán expuestos al hacer commit.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-de-entidades"><a class="anchor" href="#truecreación-de-entidades"></a>7.4. Creación de entidades</h3>
<div class="paragraph">
<p>Las entidades son clases que se corresponden con tablas de la base de datos (colecciones si se trata de MongoDB). En las entidades se definen las columnas y relaciones. Una de esas columnas debe ser la clave primaria.</p>
</div>
<div class="paragraph">
<p>A continuación, para nuestro ejemplo de libros se muestra la definición de una entidad <code>Book</code> con las columnas siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code></p>
</li>
<li>
<p><code>title</code></p>
</li>
<li>
<p><code>genre</code></p>
</li>
<li>
<p><code>description</code></p>
</li>
<li>
<p><code>author</code></p>
</li>
<li>
<p><code>publisher</code></p>
</li>
<li>
<p><code>pages</code></p>
</li>
<li>
<p><code>image_url</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.entity.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';

@Entity()
export class Book {
  @PrimaryGeneratedColumn() <i class="conum" data-value="1"></i><b>(1)</b>
  id: number;

  @Column()
  title: string;

  @Column()
  genre: string;

  @Column('text') <i class="conum" data-value="2"></i><b>(2)</b>
  description: string;

  @Column()
  author: string;

  @Column()
  publisher: string;

  @Column()
  pages: number;

  @Column()
  image_url: string;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador para indicar que es una clave primaria autonumérica</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Decorador para permitir texto largo</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueel-servicio-8"><a class="anchor" href="#trueel-servicio-8"></a>7.5. El servicio</h3>
<div class="paragraph">
<p>El servicio implementa las funciones habituales para operaciones CRUD (find, findOne, create, delete y update). Se usa el patrón repositorio para trabajar directamente sobre objetos del dominio (libros en nuestro caso) y olvidarnos de los detalles de la persistencia. Como todas las funciones interactúan con bases de datos, todas se programan de forma asíncrona y devuelven una promesa, por lo que habrá que llamarlas con <code>await</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Promesas, <code>async</code> y <code>await</code></div>
<div class="paragraph">
<p>Cuando trabajamos con bases de datos las respuestas no son inmediatas. En JavaScript las <a href="https://developer.mozilla.org/es/docs/Web/JavaScript/Referencia/Objetos_globales/Promise">promesas</a> representan valores que pueden estar disponibles ahora, en el futuro o nunca. Para facilitar el trabajo con la programación asíncrona surge la pareja <code>async/await</code>. Con esta pareja:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Las funciones son definidas con <code>async</code> para indicar que devuelven una promesa.</p>
</li>
<li>
<p>Con <code>await</code> indicamos a JavaScript que espere hasta que la promesa se cumpla y devuelva su resultado.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>await</code> sólo funciona en funciones <code>async</code>. Se coloca en funciones <code>async</code> basadas en promesas para detener la ejecución hasta que se cumpla la promesa.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Archivo <code>books/books.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable, HttpStatus, HttpException } from '@nestjs/common';
import { BookDto } from './book.dto'; <i class="conum" data-value="1"></i><b>(1)</b>
import { Book } from './book.entity'; <i class="conum" data-value="2"></i><b>(2)</b>
import { InjectRepository } from '@nestjs/typeorm'; <i class="conum" data-value="3"></i><b>(3)</b>
import { Repository } from 'typeorm'; <i class="conum" data-value="4"></i><b>(4)</b>

@Injectable()
export class BooksService {

  constructor(
    @InjectRepository(Book) private booksRepository: Repository&lt;Book&gt;, <i class="conum" data-value="5"></i><b>(5)</b>
  ) {}

  async findAll(params): Promise&lt;Book[]&gt; { <i class="conum" data-value="6"></i><b>(6)</b>
    return await this.booksRepository.find(); <i class="conum" data-value="7"></i><b>(7)</b>
  }

  async findBook(bookId: string): Promise&lt;Book&gt; {
    return await this.booksRepository.findOne({ where: { id: bookId } }); <i class="conum" data-value="8"></i><b>(8)</b>
  }

  createBook(newBook: BookDto): Promise&lt;Book&gt; {
    return this.booksRepository.save(newBook);
  }

  async deleteBook(bookId: string): Promise&lt;any&gt; {
    return await this.booksRepository.delete({ id: parseInt(bookId) });
  }

  async updateBook(bookId: string, newBook: BookDto): Promise&lt;Book&gt; { <i class="conum" data-value="9"></i><b>(9)</b>
    let toUpdate = await this.booksRepository.findOne(bookId); <i class="conum" data-value="10"></i><b>(10)</b>

    let updated = Object.assign(toUpdate, newBook); <i class="conum" data-value="11"></i><b>(11)</b>

    return this.booksRepository.save(updated); <i class="conum" data-value="12"></i><b>(12)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Estructura de un libro para insertar (tiene todo menos el <code>id</code>, que se genera en la base de datos)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Estructura completa de un libro (incluye el <code>id</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Decorador para inyectar repositorios</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Repositorio de TypeORM</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Uso del decorador <code>@InjectRepository</code> en el constructor para inyectar el <code>Repository</code> que manejará a la entidad <code>Book</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Las funciones del servicio se basan en funciones asíncronas del repositorio, que devuelven promesas y tendrán que ser llamadas con <code>await</code>. Por tanto, las funciones del servicio son <code>async</code> y devuelven promesas personalizadas al tipo con el que trabajan (libros, arrays de libros, &#8230;&#8203;)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>La llamada a los métodos del repositorio devuelven promesas, por lo que llamaremos con <code>await</code> para esperar a que se resuelvan</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Los parámetros en TypeORM se suelen pasar en JSON</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>La actualización se implementa como la recuperación del libro a modificar, la sustitución de todos sus valores excepto el <code>id</code> por los del libro pasado como parámetro y su posterior almacenamiento en la base de datos</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Recuperación del libro a modificar</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Asignación de todas las propiedades del libro <em>nuevo</em> al libro <em>antiguo</em>, excepto el <code>id</code>, que no está incluida en el libro <em>nuevo</em></td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Almacenamiento del libro en la base de datos tras su modificación</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueel-controlador-8"><a class="anchor" href="#trueel-controlador-8"></a>7.6. El controlador</h3>
<div class="paragraph">
<p>Básicamente, el controlador es el mismo que teníamos para el mockup salvo que ahora devuelve promesas, ya que las funciones del servicio ahora devuelven promesas. Además, se cambia el tipo del objeto libro. Dejamos de usar la <code>interface</code> para pasar a usar la <code>entity</code> del ORM.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/books.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Controller,
  Get,
  Param,
  Req,
  Post,
  Body,
  Delete,
  Put,
} from '@nestjs/common';
import { BooksService } from './books.service';
import { Request } from 'express';
import { BookDto } from './book.dto';
import { Book } from './book.entity'; <i class="conum" data-value="1"></i><b>(1)</b>

@Controller('books')
export class BooksController {

  constructor(private booksService: BooksService) {}

  @Get()
  findAll(@Req() request: Request): Promise&lt;Book[]&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
    console.log(request.query);
    return this.booksService.findAll(request.query);
  }

  @Get(':bookId')
  findBook(@Param('bookId') bookId: string): Promise&lt;Book&gt; {
    return this.booksService.findBook(bookId);
  }

  @Post()
  createBook(@Body() newBook: BookDto): Promise&lt;Book&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
    return this.booksService.createBook(newBook);
  }

  @Delete(':bookId')
  deleteBook(@Param('bookId') bookId: string): Promise&lt;Book&gt; {
    return this.booksService.deleteBook(bookId);
  }


  @Put(':bookId')
  updateBook(
    @Param('bookId') bookId: string,
    @Body() newBook: BookDto, <i class="conum" data-value="4"></i><b>(4)</b>
  ): Promise&lt;Book&gt; {
    return this.booksService.updateBook(bookId, newBook);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El tipo de la interfaz y el de la entidad coinciden. Nos quedamos con el de la entidad.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Las funciones ahora devuelven promesas basadas en la <code>entity</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Cambiamos el tipo <code>any</code> del <code>body</code> por el tipo del DTO del libro a crear</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Cambiamos el tipo <code>any</code> del <code>body</code> por el tipo del DTO del libro actualizado</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truemódulo-para-una-mejor-organización"><a class="anchor" href="#truemódulo-para-una-mejor-organización"></a>7.7. Módulo para una mejor organización</h3>
<div class="paragraph">
<p>Es buena práctica que en lugar de añadir cada uno de los <em>providers</em> y los <em>controllers</em> a <code>app.module.ts</code>, los agrupemos cada uno en un módulo con los <em>providers</em> y <em>controllers</em>. Posteriormente, ese módulo se importa en el array <code>imports</code> de <code>app.module.ts</code>. Además, las entidades se colocan en el módulo en un array, como argumento de <code>TypeOrmModule.forFeature()</code>.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/books.module.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { Book } from './book.entity';
import { BooksService } from './books.service';
import { BooksController } from './books.controller';
import { TypeOrmModule } from '@nestjs/typeorm';

@Module({
  imports: [TypeOrmModule.forFeature([Book])], <i class="conum" data-value="1"></i><b>(1)</b>
  providers: [BooksService], <i class="conum" data-value="2"></i><b>(2)</b>
  controllers: [BooksController], <i class="conum" data-value="3"></i><b>(3)</b>
})
export class BooksModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Las entidades van aquí</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>El servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>El controlador</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Este archivo ya está preparado para ser colocado en el array <code>imports</code> de <code>app.module.ts</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="truemejora-de-la-configuración-del-uso-del-orm"><a class="anchor" href="#truemejora-de-la-configuración-del-uso-del-orm"></a>7.8. Mejora de la configuración del uso del ORM</h3>
<div class="paragraph">
<p>Otra mejora que podríamos realizar para la configuración del uso del ORM podría ser el uso de variables de entorno. Esto evita la introducción de valores sensibles en el código, como contraseñas, usuarios de la base de datos, y demás.</p>
</div>
<div class="paragraph">
<p>La mejora que haremos se basará en lo siguiente:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inicialización de un archivo de variables de entorno.</p>
</li>
<li>
<p>Creación de un servicio de configuración del ORM a partir de los valores de las variables de entorno.</p>
</li>
<li>
<p>Modificación del archivo <code>app.module.ts</code> para usar la configuración anterior y cargar los módulos correspondientes (p.e. el de <code>BooksModule</code> creado antes).</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="trueinicialización-de-un-archivo-de-variables-de-entorno"><a class="anchor" href="#trueinicialización-de-un-archivo-de-variables-de-entorno"></a>7.8.1. Inicialización de un archivo de variables de entorno</h4>
<div class="paragraph">
<p>Archivo <code>.env</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="env" class="language-env hljs">TUTORIAL_HOST=localhost
TUTORIAL_PORT=3306
TUTORIAL_USER=root
TUTORIAL_PASSWORD=secret
TUTORIAL_DATABASE=tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truecreación-de-un-servicio-de-configuración-del-orm"><a class="anchor" href="#truecreación-de-un-servicio-de-configuración-del-orm"></a>7.8.2. Creación de un servicio de configuración del ORM</h4>
<div class="paragraph">
<p>Definiremos un servicio de configuración que acceda a las variables de entorno, especifique las variables de entorno que hay que configurar y una función que las configure.<br></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Se trata de un código precocinado que utilizaríamos en cada proyecto con TypeORM. Sólo hay que cambiar el tipo de gestor de base de datos que se va a usar (<code>mysql</code>, <code>postgres</code>, &#8230;&#8203;). Actualmente, tiene que estar en el código y no se puede pasar en una variable.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Archivo <code>config/config.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { TypeOrmModuleOptions } from '@nestjs/typeorm'; <i class="conum" data-value="1"></i><b>(1)</b>

require('dotenv').config();

class ConfigService {
  constructor(private env: { [k: string]: string | undefined }) {}

  private getValue(key: string, throwOnMissing = true): string {
    const value = this.env[key];
    if (!value &amp;&amp; throwOnMissing) {
      throw new Error(`config error - missing env.${key}`);
    }

    return value;
  }

  public ensureValues(keys: string[]) {
    keys.forEach(k =&gt; this.getValue(k, true));
    return this;
  }

  public getTypeOrmConfig(): TypeOrmModuleOptions { <i class="conum" data-value="2"></i><b>(2)</b>
    return {
      type: 'mysql', <i class="conum" data-value="3"></i><b>(3)</b>

      host: this.getValue('TUTORIAL_HOST'), <i class="conum" data-value="4"></i><b>(4)</b>
      port: parseInt(this.getValue('TUTORIAL_PORT')),
      username: this.getValue('TUTORIAL_USER'),
      password: this.getValue('TUTORIAL_PASSWORD'),
      database: this.getValue('TUTORIAL_DATABASE'),

      entities: ['dist/**/*.entity.js'], <i class="conum" data-value="5"></i><b>(5)</b>
      synchronize: true, <i class="conum" data-value="6"></i><b>(6)</b>
    };
  }
}

const configService = new ConfigService(process.env).ensureValues([
  'TUTORIAL_HOST',
  'TUTORIAL_PORT',
  'TUTORIAL_USER',
  'TUTORIAL_PASSWORD',
  'TUTORIAL_DATABASE',
]);

export { configService };</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación del módulo de configuración de TypeORM</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Función que configura las opciones de TypeORM</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configuración del gestor de base de datos a usar</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configuración de valores mediante variables de entorno</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Especificación del directorio de entidades</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Actualización de las tablas ante cambios en las entidades</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="trueactualización-de-app-module-ts-para-cargar-la-configuración-del-orm-y-los-módulos"><a class="anchor" href="#trueactualización-de-app-module-ts-para-cargar-la-configuración-del-orm-y-los-módulos"></a>7.8.3. Actualización de <code>app.module.ts</code> para cargar la configuración del ORM y los módulos</h4>
<div class="paragraph">
<p>Por último, modificamos el archivo <code>app.module.ts</code> para usar la configuración anterior y cargar el módulo <code>BooksModule</code>, que define su <em>provider</em>, controlador y la entidad contra la que se mapea.</p>
</div>
<div class="paragraph">
<p>Archivo <code>app.module.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { BooksModule } from './books/books.module';
import { TypeOrmModule } from '@nestjs/typeorm';
import { configService } from './config/config/config.service';

@Module({
  imports: [
    BooksModule, <i class="conum" data-value="1"></i><b>(1)</b>
    TypeOrmModule.forRoot( <i class="conum" data-value="2"></i><b>(2)</b>
      configService.getTypeOrmConfig(),
    ),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación del módulo</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuración de los valores de TypeORM</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truepruebas-de-los-endpoints-con-persistencia-en-la-base-de-datos"><a class="anchor" href="#truepruebas-de-los-endpoints-con-persistencia-en-la-base-de-datos"></a>7.9. Pruebas de los endpoints con persistencia en la base de datos</h3>
<div class="paragraph">
<p>En el <a href="#trueapéndice-a-datos-de-ejemplo">Apéndice A. Datos de ejemplo</a> podemos encontrar datos para insertar en la base de datos. Se podrían como <code>body</code> en un método <code>POST</code> para su creación o <code>PUT</code> para su modificación.</p>
</div>
<div class="paragraph">
<p>Usaremos Postman para mostrar los resultados de utilizar los distintos endpoints implementados.</p>
</div>
<div class="paragraph">
<p>La figura siguiente muestra la creación de un libro. El libro nuevo se pasa en el <code>body</code>. Se devuelve el libro insertado, junto al <code>id</code> generado en la base de datos. El endpoint usado es <code>/api/v1/books</code> con el método <code>POST</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/MySQLPost.png" alt="MySQLPost">
</div>
</div>
<div class="paragraph">
<p>Tras insertar todos los libros del <a href="#trueapéndice-a-datos-de-ejemplo">Apéndice A. Datos de ejemplo</a>, la figura siguiente muestra el listado de todos libros. El endpoint usado es <code>/api/v1/books</code> con el método <code>GET</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/MySQLGet.png" alt="MySQLGet">
</div>
</div>
<div class="paragraph">
<p>La figura siguiente muestra los detalles de un libro concreto (el 2). El endpoint usado es <code>/api/v1/books/2</code> con el método <code>GET</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/MySQLGetOne.png" alt="MySQLGetOne">
</div>
</div>
<div class="paragraph">
<p>La figura siguiente muestra la modificación de un libro. El <code>id</code> del libro a modificar se pasa como parámetro en la ruta y los datos del libro con sus modificaciones se pasan en el <code>body</code>. Se devuelve el libro modificado. El ejemplo muestra el cambio del número de páginas del libro 2 al valor 544. El endpoint usado es <code>/api/v1/books/2</code> con el método <code>PUT</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/MySQLPut.png" alt="MySQLPut">
</div>
</div>
<div class="paragraph">
<p>La figura siguiente muestra la eliminación de un libro. El <code>id</code> del libro a eliminar se pasa como parámetro en la ruta. Se devuelve un JSON con los libros eliminados (<code>affected</code>). Por ejemplo, para eliminar el libro con <code>id 3</code> usaríamos el endpoint <code>/api/v1/books/3</code> con el método <code>DELETE</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/MySQLDelete.png" alt="MySQLDelete">
</div>
</div>
<div class="paragraph">
<p>Si ahora volvemos a consultar todos los libros se verán los cambios en el número de páginas del libro 2 y que el libro 3 ha sido eliminado.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/MySQLUpdated.png" alt="MySQLUpdated">
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecambio-a-un-servidor-postgresql"><a class="anchor" href="#truecambio-a-un-servidor-postgresql"></a>7.10. Cambio a un servidor PostgreSQL</h3>
<div class="paragraph">
<p>El cambio a un nuevo servidor de bases de datos es bastante sencillo. Se tendrían que seguir estos pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instalación de los paquetes del nuevo gestor de bases de datos</p>
</li>
<li>
<p>Cambiar las variables de entorno con los nuevos valores de conexión a la base de datos</p>
</li>
<li>
<p>Cambio del tipo de base de datos en TypeORM</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="trueinstalación-de-los-paquetes-de-postgresql"><a class="anchor" href="#trueinstalación-de-los-paquetes-de-postgresql"></a>7.10.1. Instalación de los paquetes de PostgreSQL</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">npm install --save pg</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Creación de un contenedor con PostgreSQL</div>
<div class="paragraph">
<p>Para facilitar la configuración de la base de datos, el script siguiente lanza un contenedor PostgreSQL y crea una base de datos <code>tutorial</code> con el password <code>secret</code> (los mismos datos que se usaron para el ejemplo con MySQL)</p>
</div>
<div class="paragraph">
<p>Archivo <code>start-postgres.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="sh" class="language-sh hljs">#!/bin/bash
set -e

SERVER="tutorial_postgres";
PW="secret";
DB="tutorial";

echo "echo stop &amp; remove old docker [$SERVER] and starting new fresh instance of [$SERVER]"
(docker kill $SERVER || :) &amp;&amp; \
  (docker rm $SERVER || :) &amp;&amp; \
  docker run --name $SERVER -e POSTGRES_PASSWORD=$PW \
  -e PGPASSWORD=$PW \
  -p 5432:5432 \
  -d postgres

# wait for pg to start
echo "sleep wait for pg-server [$SERVER] to start";
SLEEP 3;

# create the db
echo "CREATE DATABASE $DB ENCODING 'UTF-8';" | docker exec -i $SERVER psql -U postgres
echo "\l" | docker exec -i $SERVER psql -U postgres</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truemodificación-de-las-variables-de-entorno"><a class="anchor" href="#truemodificación-de-las-variables-de-entorno"></a>7.10.2. Modificación de las variables de entorno</h4>
<div class="paragraph">
<p>Cambios a realizar: en el archivo <code>.env</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">TUTORIAL_HOST=localhost
TUTORIAL_PORT=5432 <i class="conum" data-value="1"></i><b>(1)</b>
TUTORIAL_USER=postgres <i class="conum" data-value="2"></i><b>(2)</b>
TUTORIAL_PASSWORD=secret
TUTORIAL_DATABASE=tutorial</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Puerto de PostgreSQL</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Usuario de PostgreSQL</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truemodificación-del-tipo-de-gestor-de-bases-de-datos"><a class="anchor" href="#truemodificación-del-tipo-de-gestor-de-bases-de-datos"></a>7.10.3. Modificación del tipo de gestor de bases de datos</h4>
<div class="paragraph">
<p>Archivo <code>config/config.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">  public getTypeOrmConfig(): TypeOrmModuleOptions {
    return {
      type: 'postgres', <i class="conum" data-value="1"></i><b>(1)</b>

      host: this.getValue('TUTORIAL_HOST'),
      port: parseInt(this.getValue('TUTORIAL_PORT')),
      username: this.getValue('TUTORIAL_USER'),
      password: this.getValue('TUTORIAL_PASSWORD'),
      database: this.getValue('TUTORIAL_DATABASE'),

      entities: ['dist/**/*.entity.js'],
      synchronize: true,
    };
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Servidor de bases de datos</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora pedimos que nos devuelva todos los libros con el endpoint <code>/api/v1/books</code> y un método <code>GET</code> obtendremos una lista vacía, ya que partimos de una base de datos Postgres vacía.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PostgresEmpty.png" alt="PostgresEmpty">
</div>
</div>
<div class="paragraph">
<p>Tras introducir un nuevo libro y volver a consultar los libros vemos cómo se recuperan los datos sin problema, confirmándose lo sencillo que es cambiar de gestor de bases de datos si se usa un ORM.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PostgresWithOne.png" alt="PostgresWithOne">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueautenticación-con-json-web-tokens"><a class="anchor" href="#trueautenticación-con-json-web-tokens"></a>8. Autenticación con JSON Web Tokens</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Queremos restringir el acceso a los endpoints de la aplicación de forma que sólo tengan acceso los usuarios autenticados. Pero no queremos que se tengan que autenticar para cada petición. Necesitamos una forma que permita a los usuarios indicar que tienen una sesión iniciada válida.</p>
</div>
<div class="paragraph">
<p>Una forma sencilla de hacer esto es mediante JWT. En nuestro caso, ya partimos de un servidor de autorización que genera tokens de acceso a partir de usuario y contraseña. En este tutorial sólo añadiremos a la aplicación la parte de comprobación de la validez de los tokens y la restricción del acceso a los endpoints para tokens válidos.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">JWT (JSON Web Tokens)</div>
<div class="paragraph">
<p>JWT es un estándar que define un método compacto y autocontenido que permite compartir de forma segura entre dos partes aserciones (claims) sobre una entidad (subject). Los datos están codificados en formato JSON incluidos en un <em>payload</em> o cuerpo del mensaje y están firmados digitalmente.</p>
</div>
<div class="paragraph">
<p>De forma predeterminada, los tokens no están cifrados. La cadena del token es una serializalización en Base64 que se puede <a href="https://jwt.io/">decodificar fácilmente</a>. La cadena del token está formada por tres partes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cabecera: Indica algoritmo (p.e. <code>HS256</code>) y tipo de token (p.e. <code>jwt</code>)</p>
</li>
<li>
<p>Payload o cuerpo: Aparecen todos los datos que queremos añadir</p>
</li>
<li>
<p>Firma: Permite verificar si el token es válido</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La firma del token se crea de forma que se pueda verificar si el remitente es quien dice ser. Dado que el token es una cadena fácilmente descifrable, si alguien manipula el token incluyendo datos o modificando el <em>payload</em> se verificaría que la firma del token no es correcta y no se puede confiar en el token recibido</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Es conveniente incluir en el token una fecha de caducidad. Un token firmado es válido mientras no se haya superado su fecha de caducidad. Así, si alguien intercepta un token, sólo podrá usarlo mientras no caduque. Una fecha de caducidad corta no expondrá los recursos protegidos de la misma forma que si se intercepta una contraseña, que dejará los recursos expuestos mientras no se detecte la pérdida de la contraseña y no se cambie.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Instalaremos los paquetes siguientes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm install @nestjs/jwt passport passport-jwt @nestjs/passport</code></pre>
</div>
</div>
<div class="paragraph">
<p>El JWT se enviará en la cabecera como <code>Bearer Token</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Bearer Token</em> o token de autorización es un <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication">esquema de autenticación HTTP</a>. El método de autenticación <em>Bearer</em> debe entenderse como "dale acceso al portador (<em>bearer</em>) de este token".</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Además, necesitaremos una <em>estrategia</em> <code>Passport</code> para la validación del token y configurar la clave secreta que se usó para firmar el token.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Passport y estrategias Passport</div>
<div class="paragraph">
<p><a href="http://www.passportjs.org/">Passport</a> es un middleware de autenticación para Node. Se usa para autenticar peticiones. Usa un mecanismo de <a href="http://www.passportjs.org/packages/"><em>estrategias</em></a> para configurar la forma de autenticación (Facebook, Twitter, GitHub, Auth0, OAuth, Google, LDAP, &#8230;&#8203;). El módulo <code>passport-jwt</code> es una estrategia Passport que permite asegurar peticiones usando JWT sin sesiones.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Crearemos una carpeta <code>utilities</code> donde guardaremos dos archivos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Estrategia JWT para Passport</p>
</li>
<li>
<p>Módulo de autorización para ser importado por los controladores que quieran asegurar sus endpoints</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="trueconfiguración-de-la-estrategia-passport"><a class="anchor" href="#trueconfiguración-de-la-estrategia-passport"></a>8.1. Configuración de la estrategia Passport</h3>
<div class="paragraph">
<p>Configuraremos JWT como estrategia Passport para la autenticación. Definiremos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extracción de JWT en cabecera como tipo <code>Bearer</code></p>
</li>
<li>
<p>Clave de verificación de firma del token</p>
</li>
<li>
<p>Función de validación del <em>payload</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Archivo <code>utilities/jwt.strategy.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { HttpException, HttpStatus, Injectable } from '@nestjs/common';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) { <i class="conum" data-value="1"></i><b>(1)</b>
  constructor() {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(), <i class="conum" data-value="2"></i><b>(2)</b>
      secretOrKey: 'secret', <i class="conum" data-value="3"></i><b>(3)</b>
    });
  }

  async validate(payload: any): Promise&lt;any&gt; { <i class="conum" data-value="4"></i><b>(4)</b>
    if (!payload) {
      throw new HttpException('Invalid token', HttpStatus.UNAUTHORIZED);
    }
    return payload;
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La clase extiende la estrategia de Passport</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extracción del token de la cabecera de la petición</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Clave de verificación de la firma del token</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Función de validación del token</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truemódulo-de-autenticación"><a class="anchor" href="#truemódulo-de-autenticación"></a>8.2. Módulo de autenticación</h3>
<div class="paragraph">
<p>El módulo de autenticación define JWT como la estrategia Passport a usar para los que importen este módulo. Además, define una propiedad (<code>user</code>) para enviar el <em>payload</em> del token en las peticiones.</p>
</div>
<div class="paragraph">
<p>Archivo <code>utilities/auth.module.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { PassportModule } from '@nestjs/passport';
import { JwtStrategy } from './jwt.strategy';
@Module({
  imports: [
    PassportModule.register({ <i class="conum" data-value="1"></i><b>(1)</b>
      defaultStrategy: 'jwt', <i class="conum" data-value="2"></i><b>(2)</b>
      property: 'user', <i class="conum" data-value="3"></i><b>(3)</b>
      session: false,
    }),
  ],
  controllers: [],
  providers: [JwtStrategy], <i class="conum" data-value="4"></i><b>(4)</b>
  exports: [PassportModule], <i class="conum" data-value="5"></i><b>(5)</b>
})
export class AuthModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuración del módulo Passport</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuración a estrategia <code>jwt</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Definición de propiedad <code>user</code> para el envío del <em>payload</em> en las peticiones</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><em>provider</em> configurado en el paso anterior</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Exportar el módulo ya configurado</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El valor <code>jwt</code> definido en <code>defaultStrategy</code> se usará posteriormente a la hora de proteger los endpoints.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truerestricción-del-acceso-de-los-endpoints"><a class="anchor" href="#truerestricción-del-acceso-de-los-endpoints"></a>8.3. Restricción del acceso de los endpoints</h3>
<div class="paragraph">
<p>Añadimos el módulo <code>AuthModule</code> definido en el paso anterior al módulo de los endpoints que queremos proteger. El módulo <code>AuthModule</code> definía la configuración de la estrategia y el servicio de validación JWT a utilizar.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/books.module.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { AuthModule } from '../utilities/auth.module';

@Module({
  imports: [
    ...
    , AuthModule], <i class="conum" data-value="1"></i><b>(1)</b>
  providers: [...],
  controllers: [...],
})

export class BooksModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación del módulo definido</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez definido el módulo, ya sólo falta proteger los endpoints. Podremos hacerlo de dos formas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Proteger de una vez todos los endpoints del controlador</p>
</li>
<li>
<p>Proteger sólo los endpoints indicados</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La protección se hará usando el decorador <code>@UseGuards()</code>. Si el decorador se coloca antes de la definición de la clase, quedan protegidos todos los endpoints definidos en la clase. Si no se desea una protección de todos los endpoints, se colocará <code>@UseGuards()</code> antes de la definición de aquellos endpoints que se quieran proteger.</p>
</div>
<div class="paragraph">
<p>A <code>@UseGuards()</code> se le pasa como argumento el nombre de estrategia de autenticación definida. En nuestro caso, la nuestra la habíamos definido como <code>jwt</code> en <code>Auth.module.ts</code>.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  ...
  UseGuards, <i class="conum" data-value="1"></i><b>(1)</b>
} from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport'; <i class="conum" data-value="2"></i><b>(2)</b>
...
@Controller('books')
@UseGuards(AuthGuard('jwt')) <i class="conum" data-value="3"></i><b>(3)</b>
...
export class BooksController {
...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación del decorador <code>UseGuards</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Importación de <code>AuthGuard</code> para especificar la estrategia de autenticación a utilizar</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Restricción del acceso a <code>jwt</code> de forma global (a nivel de clase) para todos los endpoints del controlador</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si tratamos de acceder sin token o con un token inválido a cualquier endpoint definido, obtendremos un mensaje de error <code>401 Unauthorized</code>, tal y como muestra la figura.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/JWT-SinAutenticar.png" alt="JWT SinAutenticar">
</div>
</div>
<div class="paragraph">
<p>Si pasamos en la cabecera de autorización pasamos el token indicando que es <code>Bearer Token</code> tendremos acceso a los endpoints, tal y como muestra la figura.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/JWT-Autenticado.png" alt="JWT Autenticado">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truedocumentación-de-la-api-con-swagger-openapi"><a class="anchor" href="#truedocumentación-de-la-api-con-swagger-openapi"></a>9. Documentación de la API con Swagger (OpenAPI)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>NestJS cuenta con un módulo que permite la generación automática de la documentación en <a href="https://swagger.io/">Swagger (OpenAPI)</a>. Esto permite obtener la documentación de la API y sus endpoints mediante decoradores en el código.</p>
</div>
<div class="paragraph">
<p>Comenzaremos instalando los paquetes de Swagger en el proyecto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ npm install --save @nestjs/swagger swagger-ui-express</code></pre>
</div>
</div>
<div class="paragraph">
<p>A continación hay que modificar el archivo <code>main.js</code> usando la clase <code>SwaggerModule</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger'; <i class="conum" data-value="1"></i><b>(1)</b>

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.setGlobalPrefix('api/v1');

  // Configurar títulos de documnentación
  const options = new DocumentBuilder() <i class="conum" data-value="2"></i><b>(2)</b>
    .setTitle('Bookstore REST API')
    .setDescription('API REST de Bookstore')
    .setVersion('1.0')
    .addBearerAuth( <i class="conum" data-value="3"></i><b>(3)</b>
      { type: 'http', scheme: 'bearer', bearerFormat: 'JWT', in: 'header' },
      'access-token', <i class="conum" data-value="4"></i><b>(4)</b>
    )
    .build();
  const document = SwaggerModule.createDocument(app, options); <i class="conum" data-value="5"></i><b>(5)</b>

  // La ruta en que se sirve la documentación
  SwaggerModule.setup('docs', app, document); <i class="conum" data-value="6"></i><b>(6)</b>

  await app.listen(3000);
}
bootstrap();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importaciones necesarias</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuración de opciones generales de la documentación (título, versión, &#8230;&#8203;)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Habilita el uso de autenticación JWT con <code>Bearer Token</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Nombre asignado a esta configuración de autenticación</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Creación de la documentación con las opciones configuradas</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Especificación de la ruta relativa donde se sirve la documentación Swagger</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La configuración de <code>in: header</code> en <code>addBearerAuth()</code> permite una autenticación global asignándole un nombre (p.e. <code>access-token</code>). Si a nivel de clase se especifica <code>@ApiBearerAuth('access-token')</code> todos los endpoints quedarían autenticados tras la autenticación global. En cambio, si se opta por una autenticación individual, habría que incluir <code>@ApiBearerAuth('access-token')</code> antes de cada endpoint que quisiera usar el método de autenticación denominado <code>access-token</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="truedocumentación-de-dtos-entidades-clases-e-interfaces"><a class="anchor" href="#truedocumentación-de-dtos-entidades-clases-e-interfaces"></a>9.1. Documentación de DTOs, entidades, clases e interfaces</h3>
<div class="paragraph">
<p>En clases DTO, así como en entidades, clases e interfaces, incluiremos un decorador <code>@ApiProperty()</code> antes de cada propiedad. A este decorador se le puede pasar un ejemplo que facilite la introducción al uso de la API.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El uso de decoradores en los DTO y entidades permite que aparezcan el tipo y un ejemplo definido siempre que use un DTO o una entidad, lo que facilita bastante la interacción con la documentación.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.dto.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger'; <i class="conum" data-value="1"></i><b>(1)</b>

export class BookDto {
  @ApiProperty({ example: 'Don Quijote de la Mancha' }) <i class="conum" data-value="2"></i><b>(2)</b>
  readonly title: string;

  @ApiProperty({ example: 'Novela' })
  readonly genre: string;

  @ApiProperty({
    example: 'Esta edición del Ingenioso hidalgo don Quijote de la Mancha ...',
  })
  readonly description: string;

  @ApiProperty({ example: 'Miguel de Cervantes' })
  readonly author: string;

  @ApiProperty({ example: 'Santillana' })
  readonly publisher: string;

  @ApiProperty({ example: 592 })
  readonly pages: number;

  @ApiProperty({ example: 'www.imagen.com/quijote.png' })
  readonly image_url: string;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación de decoradores</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuración de propiedades</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La anotación Swagger de la entidad es prácticamente igual a la del DTO salvo que también incluye el <code>id</code>.</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/book.entity.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';

@Entity()
export class Book {
  @ApiProperty({ example: 99 })
  @PrimaryGeneratedColumn()
  id: number;

  @ApiProperty({ example: 'Don Quijote de la Mancha' })
  @Column()
  title: string;

  @ApiProperty({ example: 'Novela' })
  @Column()
  genre: string;

  @ApiProperty({
    example: 'Esta edición del Ingenioso hidalgo don Quijote de la Mancha ...',
  })
  @Column('text')
  description: string;

  @ApiProperty({ example: 'Miguel de Cervantes' })
  @Column()
  author: string;

  @ApiProperty({ example: 'Santillana' })
  @Column()
  publisher: string;

  @ApiProperty({ example: 592 })
  @Column()
  pages: number;

  @ApiProperty({ example: 'www.imagen.com/quijote.png' })
  @Column()
  image_url: string;
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>También hay que incluir decoradores <code>@ApiProperty</code> en interfaces y otras clases definidas para tipado.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truedocumentación-de-los-controladores"><a class="anchor" href="#truedocumentación-de-los-controladores"></a>9.2. Documentación de los controladores</h3>
<div class="paragraph">
<p>Los métodos de los controladores se pueden agrupar mediante etiquetas Swagger. Para ello se usa el decorador <code>@ApiTags()</code>. Se puede usar el decorador a nivel de clase, lo que combinará a todos los métodos en el mismo grupo. También se puede usar a nivel de método.</p>
</div>
<div class="paragraph">
<p>Si se dispone de autenticación JWT, se incluirá el decorador <code>@ApiBearerAuth()</code> con el nombre usado para denominar al método de autenticación definido. Si el decorador se usa a nivel de clase, todos los endpoints de la clase quedarán autenticados al realizar una autenticación global.</p>
</div>
<div class="paragraph">
<p>En cada operación se incluirá:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un decorador <code>@ApiOperation()</code> para proporcionar una descripción para la operación</p>
</li>
<li>
<p>Un decorador <code>@ApiResponse()</code> por cada respuesta que proporcione la operación (p.e. 200, 403, &#8230;&#8203;)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A continuación se muestra un fragmento de la anotación en <code>books/books.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { BookDto } from './book.dto'; <i class="conum" data-value="1"></i><b>(1)</b>
import { Book } from './book.entity'; <i class="conum" data-value="2"></i><b>(2)</b>
import { <i class="conum" data-value="3"></i><b>(3)</b>
  ApiOperation,
  ApiResponse,
  ApiTags,
  ApiBearerAuth,
} from '@nestjs/swagger';
...
@ApiTags('book') <i class="conum" data-value="4"></i><b>(4)</b>
@Controller('books')
@UseGuards(AuthGuard('jwt')) <i class="conum" data-value="5"></i><b>(5)</b>
@ApiBearerAuth('access-token') <i class="conum" data-value="6"></i><b>(6)</b>
export class BooksController {
...
  /** <i class="conum" data-value="7"></i><b>(7)</b>
   *
   * @returns {Book[]} Devuelve una lista de libros
   * @param {Request} request Lista de parámetros para filtrar
   */
  @Get()
  @ApiOperation({ summary: 'Obtener lista de libros' }) <i class="conum" data-value="8"></i><b>(8)</b>
  @ApiResponse({ <i class="conum" data-value="9"></i><b>(9)</b>
    status: 201,
    description: 'Lista de libros',
    type: Book, <i class="conum" data-value="10"></i><b>(10)</b>
  })
  findAll(@Req() request: Request): Promise&lt;Book[]&gt; {
  ...
  }
...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación del DTO para enlazar bien la documentación</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Importación de la entidad para enlazar bien la documentación</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Importación de paquetes Swagger</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Especificación de la etiqueta para combinar a todos las operaciones de este controlador en el grupo <code>book</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Protección con JWT a nivel de clase de todos los endpoints</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Configuración de autenticación en Swagger a nivel de clase</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Documentación del retorno y de los parámetros del endpoint</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Descripción de la operación</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Respuesta 201</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Al especificar el tipo, se puede ver un ejemplo de la respuesta en la documentación</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La figura siguiente muestra cómo quedaría inicialmente la documentación servida el la ruta <code>docs</code>. Como aún no se ha proporcionado el token, los endpoints aparecen con un candado abierto indicando que no se posible su acceso.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Swagger-Inicio.png" alt="Swagger Inicio">
</div>
</div>
<div class="paragraph">
<p>Si probásemos un endpoint (p.e. <code>GET /books</code> para obtener la lista de todos los libros) con <code>Try out</code> se nos rechazaría el acceso, tal y como ilustra la figura siguiente.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Swagger-NoAutenticado.png" alt="Swagger NoAutenticado">
</div>
</div>
<div class="paragraph">
<p>Para introducir el token, pulsaremos el botón <code>Authorize</code> superior. En el cuadro de diálogo introducimos el token y pulsamos sobre <code>Authorize</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Swagger-Token.png" alt="Swagger Token">
</div>
</div>
<div class="paragraph">
<p>Si el token introducido es válido, quedaremos autorizados.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Swagger-TokenValido.png" alt="Swagger TokenValido">
</div>
</div>
<div class="paragraph">
<p>Al quedar autorizados, como definimos la autenticación para todo el controlador, quedaría abierto el acceso a todos los endpoints, mostrándose ahora todos los candados cerrados.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Swagger-Autenticado.png" alt="Swagger Autenticado">
</div>
</div>
<div class="paragraph">
<p>Si ahora volvemos a probar el endpoint para obtener la lista de libros, la lista se recuperará y se mostrará en el propio Swagger.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Swagger-Respuesta.png" alt="Swagger Respuesta">
</div>
</div>
<div class="paragraph">
<p>Esto hace a Swagger una opción muy interesante para los proyectos de APIs ya que no sólo es una herramienta de documentación, sino que también permite la interacción directa con la API. Con una buena documentación enriquecida con la descripción de sus parámetros, tipos y ejemplos tendremos una plataforma extraordinaria para la documentación y uso de APIs.</p>
</div>
</div>
<div class="sect2">
<h3 id="truedescarga-de-json"><a class="anchor" href="#truedescarga-de-json"></a>9.3. Descarga de JSON</h3>
<div class="paragraph">
<p>Para generar y poder descargar un archivo Swagger JSON basta con añadir <code>-json</code> a la ruta desde la que se sirve la documentación. Este archivo podrá ser alojado en una plataforma desde la que se sirva la documentación de las APIs de la organización.</p>
</div>
<div class="paragraph">
<p>En nuestro caso, <code><a href="http://localhost:3001/docs-json" class="bare">http://localhost:3001/docs-json</a></code> generará el archivo Swagger JSON de nuestra aplicación.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Swagger-JSON.png" alt="Swagger JSON">
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El elemento <code>servers</code> está sin definir. De cara a subir este JSON a un servidor de Swagger, se debería configurar este elemento con el nombre DNS o IP del servidor donde se aloja la API para poder interactuar con la API.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para más información sobre Swagger, consultar la  <a href="https://docs.nestjs.com/recipes/swagger">documentación oficial</a></p>
</div>
</div>
<div class="sect2">
<h3 id="truecambio-del-frontend"><a class="anchor" href="#truecambio-del-frontend"></a>9.4. Cambio del frontend</h3>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/nestjs-redoc">NestJS-Redoc</a> es un frontend para la especificación de la API en Swagger. Está basado en <a href="https://github.com/Redocly/redoc">Redoc</a> y permite una presentación más sencilla y elaborada que la proporcionada por Swagger UI ofreciendo además funciones de búsqueda.</p>
</div>
<div class="paragraph">
<p>La instalación se realiza con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm install --save nestjs-redoc@1.3.1</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A fecha de la creación de este tutorial la versión actual de NestJS Redoc (1.3.2) tiene una incompatibilidad con la versión actual de NestJS (7.0.0). Mientras se resuelve hay que usar la versión 1.3.1 de NestJS Redoc.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>NestJS-Redoc se apoya en la configuración realizada con Swagger y añade unas opciones propias (p.e. logo y título de la página). Al igual que con Swagger, la configuración de Redoc se realiza en <code>main.ts</code>. Sin embargo, hay que indicar que la documentación ya no la sirve Swagger UI, sino Redoc. De esto se encarga el método <code>setup</code> de <code>RedocModule</code> tal y como se muestra a continuación.</p>
</div>
<div class="paragraph">
<p>Archivo <code>main.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="typescript" class="language-typescript hljs">...
import { RedocModule, RedocOptions } from 'nestjs-redoc'; <i class="conum" data-value="1"></i><b>(1)</b>

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Configurar títulos de documnentación
  const options = new DocumentBuilder() <i class="conum" data-value="2"></i><b>(2)</b>
    .setTitle('Sample REST API')
    .setDescription('Sample API REST Description')
    .setVersion('1.0')
    .addBearerAuth(
      { type: 'http', scheme: 'bearer', bearerFormat: 'JWT', in: 'header' },
      'access-token',
    )
    .build();
  const document = SwaggerModule.createDocument(app, options);

  const redocOptions: RedocOptions = { <i class="conum" data-value="3"></i><b>(3)</b>
    favicon: 'https://www.ual.es/favicon.ico',
    title: 'API Reservas',
    logo: {
      url:
        'https://www.ual.es/application/themes/ual/images/logoual25-300px.png',
      backgroundColor: '#0082B7',
    },
    sortPropsAlphabetically: true,
    hideDownloadButton: false,
    hideHostname: false,
    noAutoAuth: false,
  };

  // La ruta en que se sirve la documentación
  //SwaggerModule.setup('docs', app, document); <i class="conum" data-value="4"></i><b>(4)</b>
  await RedocModule.setup('/docs', app, document, redocOptions); <i class="conum" data-value="5"></i><b>(5)</b>

  await app.listen(3000);
}
bootstrap();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importaciones de Redoc</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuración de opciones generales de la documentación Swagger</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configuración de las opciones de Redoc</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>La documentación ya no la sirve Swagger UI</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Servir la documentación con Redoc usando las opciones definidas en <code>redocOptions</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra el nuevo aspecto de la documentación Swagger.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Redoc.png" alt="Redoc">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para más información sobre las opciones disponibles en Redoc, consultar la <a href="https://github.com/mxarc/nestjs-redoc#readme">documentación oficial</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Puedes encontrar ejemplos de uso de Redoc en:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.docker.com/engine/api/v1.25/">Docker Engine API</a></p>
</li>
<li>
<p><a href="https://www.commbox.io/api/">Commbox</a></p>
</li>
<li>
<p><a href="https://www.zuora.com/developer/api-reference/">Zuora</a></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La opción de envío de peticiones a la API a través de Swagger (<em>Try it out</em>) es una función de pago en Redoc (<a href="https://redoc.ly/">Redocly</a>) por lo que el uso de Redoc en su versión open source se limita a la documentación sin contar con la funcionalidad de envío de peticiones.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truelogging"><a class="anchor" href="#truelogging"></a>10. Logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A medida que las aplicaciones se complican y a medida que se les exige mayor rendimiento se vuelve más necesario contar un registro de logs que nos ayude a encontrar fallos o problemas de rendimiento. NestJS incorpora un sistema de logging que permite controlar los mensajes que se registran en el log y especificar su salida. Sin embargo, Nest recomienda usar otros paquetes de logging más avanzados y versátiles para sistemas en producción, como <a href="https://github.com/winstonjs/winston">Winston</a>. Entre las características de Winston se encuentran: soporte para gran cantidad de opciones de almacenamiento, niveles de log y formateo de logs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Opciones de almacenamiento: Winston es una librería de logging que permite varios <a href="https://github.com/winstonjs/winston/blob/master/docs/transports.md#winston-core"><em>transportes</em></a>. Básicamente, un transporte es un dispositivo de almacenamiento para almacenar logs. Cada instancia de un logger de Winston puede tener varios transportes configurados para niveles diferentes. Ejemplos de transportes son consola, archivo, archivos de rotación diaria, Syslog, Datadog, ElasticSearch o MongoDB.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Una opción de transporte centralizada, como la basada en ElasticSearch, evitaría el problema de la fragmentación de logs que se produce cuando tenemos varias copias de la aplicación (p.e. en varios contenedores), cada una con sus archivos de log independientes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Niveles: Los niveles de log indican la gravedad, que van desde una caída del sistema hasta el aviso de una función marcada como obsoleta. Los niveles de log ayudan a ver rápidamente los logs que necesitan atención. Para cada nivel se puede configurar la cantidad de datos y de detalles a registrar.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Los niveles de log se priorizan de 0 a 5 (de mayor a menor prioridad)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0: <code>error</code></p>
</li>
<li>
<p>1: <code>warn</code></p>
</li>
<li>
<p>2: <code>info</code></p>
</li>
<li>
<p>3: <code>verbose</code></p>
</li>
<li>
<p>4: <code>debug</code></p>
</li>
<li>
<p>5: <code>silly</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Al especificar un nivel de log para un transporte concreto, se registará cualquier cosa con ese nivel o con una prioridad mayor (p.e. si se especifica <code>info</code>, se registrará cualquier cosa al nivel <code>info</code> así como a las niveles  <code>warn</code> y <code>error</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Formato: Winston ofrece formateo en JSON, uso de colores y manipulación de formatos. ya que posteriormente surgen problemas si todo son cadenas.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="trueconfiguración-de-winston"><a class="anchor" href="#trueconfiguración-de-winston"></a>10.1. Configuración de Winston</h3>
<div class="paragraph">
<p>Comenzamos instalando con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">npm install --save nest-winston winston</code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación, se configuran las opciones de nivel de log, transporte y formato en <code>app.module.ts</code>. En este ejemplo se registran los logs con nivel <code>info</code> (que registrará <code>info, warn</code> y <code>error</code>). Las opciones de formato incluyen la fecha, la interpolación de cadenas y la salida en JSON. Como transportes, se usarán 3 archivos de logs independientes (uno para errores, otro para <code>debug</code> y otro para <code>info</code>) y salida por consola para nivel <code>debug</code>.</p>
</div>
<div class="paragraph">
<p>Archivo <code>app.module.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { WinstonModule } from 'nest-winston'; <i class="conum" data-value="1"></i><b>(1)</b>
import * as winston from 'winston';
import * as path from 'path';

@Module({
  imports: [
    ...
    WinstonModule.forRoot({
      level: 'info', <i class="conum" data-value="2"></i><b>(2)</b>
      format: winston.format.combine( <i class="conum" data-value="3"></i><b>(3)</b>
        winston.format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        winston.format.errors({ stack: true }),
        winston.format.splat(),
        winston.format.json(),
      ),
      transports: [ <i class="conum" data-value="4"></i><b>(4)</b>
        new winston.transports.File({
          dirname: path.join(__dirname, './../log/debug/'),
          filename: 'debug.log',
          level: 'debug',
        }),
        new winston.transports.File({
          dirname: path.join(__dirname, './../log/error/'),
          filename: 'error.log',
          level: 'error',
        }),
        new winston.transports.File({
          dirname: path.join(__dirname, './../log/info/'),
          filename: 'info.log',
          level: 'info',
        }),
        new winston.transports.Console({ level: 'debug' }),
      ],
    }),
  ],
  controllers: [...],
  providers: [...],
})
export class AppModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importaciones necesarias de Winston y paths para tratar con las rutas de los archivos de log</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuración del nivel <code>info</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Formato definido para las entradas de log</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Transportes: 3 archivos y salida por consola para nivel mínimo de <code>debug</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El <em>trasporte</em> para archivos tiene otras opciones interesantes como:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>maxsize</code>: Tamaño máximo en bytes del archivo de log. Al superar el tamaño se crea un nuevo archivo de log.</p>
</li>
<li>
<p><code>maxFiles</code>: Limita el número de archivos a crear cuando se excede el tamaño máximo del archivo de logs</p>
</li>
<li>
<p><code>zippedArchive</code>: Si es <code>true</code>, se comprimen todos los archivos de log excepto el actual.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueregistro-de-logs-con-winston"><a class="anchor" href="#trueregistro-de-logs-con-winston"></a>10.2. Registro de logs con Winston</h3>
<div class="paragraph">
<p>Aquí vamos a ver cómo un endpoint registra una entrada de log. En el controlador y en general en cualquier clase que usase Winston, haríamos la configuración siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { <i class="conum" data-value="1"></i><b>(1)</b>
    ...
    Inject } from '@nestjs/common';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { Logger } from 'winston';

@Controller()
export class SomeController {
  constructor(
    ...
    @Inject(WINSTON_MODULE_PROVIDER) private readonly logger: Logger, <i class="conum" data-value="2"></i><b>(2)</b>
  ) {
  ...
  }
  ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación de paquetes y opciones de Winston</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Winston se inyecta en el constructor y queda disponible como <code>logger</code></td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Comprobar que el <code>Logger</code> que se importa es el de Winston y no otro, como el de Nest o el de TypeORM.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para crear una entrada de log se indica el nivel de la entrada de log, y concatenaríamos pares clave-valor que queremos registrar en el log.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">    this.logger.log({
      level: 'info',
      message: 'Hola',
      service: 'Books',
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como se trata de una entrada de tipo <code>info</code>, quedaría registrada en <code>log/info.log</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{"level":"info","message":"Hola","service":"Books","timestamp":"2020-08-05 19:14:08"} <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>timestamp</code> puede ser incluido de forma automática si se configura así en las opciones de las entradas de log</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En una entrada de log son obligatorios los campos <code>level</code> y <code>message</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truelog-de-operaciones-de-la-api"><a class="anchor" href="#truelog-de-operaciones-de-la-api"></a>10.3. Log de operaciones de la API</h3>
<div class="paragraph">
<p>Para finalizar veremos cómo registrar en el log operaciones de la API. Pasaremos por alto el control de errores y sólo haremos el caso feliz en que la operación se lleva a cabo con éxito. La entrada de log incluirá lo siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>level</code>: Indica el nivel de la entrada de log</p>
</li>
<li>
<p><code>message</code>: Texto de la entrada</p>
</li>
<li>
<p><code>statusCode</code> Código HTTP de la respuesta</p>
</li>
<li>
<p><code>method</code>: Método HTTP de la petición</p>
</li>
<li>
<p><code>url</code>: URL solicitada</p>
</li>
<li>
<p><code>user</code>: Usuario que ha realizado la petición. Se obtiene del JWT enviado en la cabecera</p>
</li>
<li>
<p><code>duration</code>: Tiempo en ms para resolver la petición</p>
</li>
<li>
<p><code>timestamp</code>: Instante en el que se ha realizado la petición</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La mecánica que usaremos para atender una petición de la API será la siguiente:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Obtener la fecha del sistema</p>
</li>
<li>
<p>Llamar al servicio que resuelve la petición</p>
</li>
<li>
<p>Llamada a una función auxiliar que escribe una entrada en el log</p>
</li>
<li>
<p>Devolver los datos de la petición</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para obtener datos de la petición, como el método HTTP, url, usuario y demás, incluiremos un parámetro de tipo <code>Request</code> en cada función de la API.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Archivo <code>books/books.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">  ...
  @Get()
  ...
  findAll(@Req() request: Request): Promise&lt;Book[]&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
    let startTime = Date.now(); <i class="conum" data-value="2"></i><b>(2)</b>
    let data = this.booksService.findAll(request.query); <i class="conum" data-value="3"></i><b>(3)</b>

    this.writeLog(startTime, request, 200); <i class="conum" data-value="4"></i><b>(4)</b>

    return data; <i class="conum" data-value="5"></i><b>(5)</b>
  }
  ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Incluir un parámetro <code>Request</code> para incluir datos como la url, método HTTP y demás en la entrada de log</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Obtener la hora antes de llamar al servicio que resuelve la petición</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Llamar al servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Llamar a la función auxiliar que escribe la entrada de log</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Devolver los datos de la petición</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Función auxiliar</p>
</div>
<div class="paragraph">
<p>Archivo <code>books/books.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">...
  writeLog(startTime: any, request: any, statusCode: number) {
    let finishTime = Date.now();
    let elapsedTime = finishTime - startTime;

    this.logger.log({
      level: 'info',
      message: '',
      statusCode: statusCode,
      method: request['method'],
      url: request['url'],
      user: request['user'].username,
      duration: elapsedTime,
    });
  }
  ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras hacer una petición <code>GET /api/v1/books/1</code> obtendríamos esta entrada en el archivo de logs <code>log/info/info.log</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{"level":"info","message":"","statusCode":200,"method":"GET","url":"/api/v1/books/1","user":"mtorres","duration":8,"timestamp":"2020-08-06 13:01:49"}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En este ejemplo se ha optado por definir una entrada de log con campos independientes fuera de <code>message</code>. Otra opción es incluirlos dentro de <code>message</code> y usar interpolación de variables.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truemejora-del-controlador-con-estados-http-estándar"><a class="anchor" href="#truemejora-del-controlador-con-estados-http-estándar"></a>11. Mejora del controlador con estados HTTP estándar</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora hemos devuelto códigos de estado en forma numérica. Es mejor práctica devolverlos codificados (p.e. <code>OK</code>, <code>CREATED</code>, &#8230;&#8203;). <code>HttpStatus</code> es un <code>enum</code> de NestJS que facilita la devolución de códigos de estado (ver <a href="https://github.com/nestjs/nest/blob/master/packages/common/enums/http-status.enum.ts">lista de códigos de estado</a>).</p>
</div>
<div class="paragraph">
<p>A continuación se muestra cómo quedaría en el controlador el código de la petición de recuperación de todos los libros.</p>
</div>
<div class="paragraph">
<p>Archivo <code>src/books/books.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { HttpStatus } from '@nestjs/common'; <i class="conum" data-value="1"></i><b>(1)</b>
...
  @Get()
  @ApiOperation({ summary: 'Obtener lista de libros' })
  @ApiResponse({
    status: HttpStatus.OK, <i class="conum" data-value="2"></i><b>(2)</b>
    description: 'Lista de libros',
    type: [Book],
  })
  async findAll(@Req() request: Request, @Res() res): Promise&lt;Book[]&gt; {
    let startTime = Date.now();
    let data = await this.booksService.findAll(request.query); <i class="conum" data-value="3"></i><b>(3)</b>

    this.writeLog(startTime, request, HttpStatus.OK); <i class="conum" data-value="4"></i><b>(4)</b>
    return res.status(HttpStatus.OK) <i class="conum" data-value="5"></i><b>(5)</b>
    .json({ <i class="conum" data-value="6"></i><b>(6)</b>
      statusCode: HttpStatus.OK,
      message: message,
      data: data,
    });
  }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enum <code>HttpStatus</code> para los códigos de estado HTTP</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Swagger ahora devuelve el estado codificado</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Almacenar en <code>data</code> para su uso posterior lo que devuelve la llamada al método del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Entrada de log con el código de estado</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Devolver código de estado codificado</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>El resultado ahora se devuelve en un JSON formado por tres elementos: <code>statusCode</code>, <code>message</code> y <code>data</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Análogamente, estos cambios también se deben llevar a cabo en el resto de rutas (endpoints) definidas en el controlador. A continuación se muestra el código completo.</p>
</div>
<div class="paragraph">
<p>Archivo <code>src/books/books.controller.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Controller,
  Get,
  Param,
  Req,
  Post,
  Body,
  Delete,
  Put,
  Inject,
  UseGuards,
  Res,
} from '@nestjs/common';
import { BooksService } from './books.service';
import { Request } from 'express';
import { BookDto } from './book.dto';
import {
  ApiOperation,
  ApiResponse,
  ApiTags,
  ApiBearerAuth,
} from '@nestjs/swagger';
import { Book } from './book.entity';
import { AuthGuard } from '@nestjs/passport';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { Logger } from 'winston';
import { HttpStatus } from '@nestjs/common'; <i class="conum" data-value="1"></i><b>(1)</b>
@ApiTags('book')
@Controller('books')
@UseGuards(AuthGuard('jwt'))
@ApiBearerAuth('access-token')
export class BooksController {
  constructor(
    private booksService: BooksService,
    @Inject(WINSTON_MODULE_PROVIDER) private readonly logger: Logger,
  ) {}


  @Get() <i class="conum" data-value="2"></i><b>(2)</b>
  @ApiOperation({ summary: 'Obtener lista de libros' })
  @ApiResponse({
    status: HttpStatus.OK,
    description: 'Lista de libros',
    type: [Book],
  })
  async findAll(@Req() request: Request, @Res() res): Promise&lt;Book[]&gt; {
    let startTime = Date.now();
    let data = await this.booksService.findAll(request.query);

    this.writeLog(startTime, request, HttpStatus.OK);
    return res.status(HttpStatus.OK).json({
      statusCode: HttpStatus.OK,
      message: 'OK',
      data: data,
    });
  }

  @Get(':bookId') <i class="conum" data-value="3"></i><b>(3)</b>
  @ApiOperation({ summary: 'Devuelve información sobre un libro específico' })
  @ApiResponse({
    status: HttpStatus.OK,
    description: 'Datos del libro',
    type: Book,
  })
  async findBook(
    @Req() request: Request,
    @Param('bookId') bookId: string,
    @Res() res,
  ): Promise&lt;Book&gt; {
    let message = 'OK';
    let startTime = Date.now();
    let data = await this.booksService.findBook(bookId);

    if (!data) {
      message = 'A book with the specified id was not found';
    }

    this.writeLog(startTime, request, HttpStatus.OK);
    return res.status(HttpStatus.OK).json({
      statusCode: HttpStatus.OK,
      message: message,
      data: data,
    });
  }

  @Post() <i class="conum" data-value="4"></i><b>(4)</b>
  @ApiOperation({ summary: 'Crear un libro' })
  @ApiResponse({
    status: HttpStatus.CREATED,
    description: 'Datos del libro creado',
    type: Book,
  })
  @ApiResponse({ status: 403, description: 'Forbidden.' })
  async createBook(
    @Req() request: Request,
    @Body() newBook: BookDto,
    @Res() res,
  ): Promise&lt;Book&gt; {
    let startTime = Date.now();
    let data = await this.booksService.createBook(newBook);

    this.writeLog(startTime, request, HttpStatus.CREATED);
    return res.status(HttpStatus.CREATED).json({
      statusCode: HttpStatus.CREATED,
      message: 'OK',
      data: data,
    });
  }

  @Delete(':bookId') <i class="conum" data-value="5"></i><b>(5)</b>
  @ApiOperation({ summary: 'Eliminar un libro específico' })
  @ApiResponse({
    status: 200,
    description: 'Datos del libro eliminado',
  })
  async deleteBook(
    @Req() request: Request,
    @Param('bookId') bookId: string,
    @Res() res,
  ): Promise&lt;Book&gt; {
    let message = 'OK';
    let startTime = Date.now();
    let data = await this.booksService.deleteBook(bookId);

    if (data['affected'] == 0) {
      message = 'A book with the specified id was not found';
      data = {};
    }

    this.writeLog(startTime, request, HttpStatus.OK);
    return res.status(HttpStatus.OK).json({
      statusCode: HttpStatus.OK,
      message: message,
      data: data,
    });
  }

  @Put(':bookId') <i class="conum" data-value="6"></i><b>(6)</b>
  @ApiOperation({ summary: 'Actualizar un libro específico' })
  @ApiResponse({
    status: 200,
    description: 'Datos del libro actualizado',
    type: Book,
  })
  async updateBook(
    @Req() request: Request,
    @Param('bookId') bookId: string,
    @Body() newBook: BookDto,
    @Res() res,
  ): Promise&lt;Book&gt; {
    let message = 'OK';
    let startTime = Date.now();
    let data = await this.booksService.updateBook(bookId, newBook);

    if (!data) {
      message = 'A book with the specified id was not found';
    }

    this.writeLog(startTime, request, HttpStatus.OK);
    return res.status(HttpStatus.OK).json({
      statusCode: HttpStatus.OK,
      message: message,
      data: data,
    });
  }

  writeLog(startTime: any, request: any, statusCode: number) {
    let finishTime = Date.now();
    let elapsedTime = finishTime - startTime;

    this.logger.log({
      level: 'info',
      message: '',
      statusCode: statusCode,
      method: request['method'],
      url: request['url'],
      user: request['user'].username,
      duration: elapsedTime,
    });
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enum <code>HttpStatus</code> para los códigos de estado HTTP</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ruta para devolver todos los libros adaptada para trabajar con códigos de <code>HttpStatus</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ruta para devolver un libro específico adaptada para trabajar con códigos de <code>HttpStatus</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ruta para crear un libro adaptada para trabajar con códigos de <code>HttpStatus</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Ruta para borrar un libro específico adaptada para trabajar con códigos de <code>HttpStatus</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Ruta para modificar un libro específico adaptada para trabajar con códigos de <code>HttpStatus</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truedocumentación-del-código"><a class="anchor" href="#truedocumentación-del-código"></a>12. Documentación del código</h2>
<div class="sectionbody">
<div class="paragraph">
<p>NestJS usa <a href="https://compodoc.app/">Compodoc</a>, una herramienta de documentación para Angular. Al documentar el código, los miembros del equipo de desarrollo podrán entender fácilmente las características de la aplicación o librería. La documentación se anota mediante <a href="https://jsdoc.app/">JSDoc</a> siguiendo este esquema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">/**
 * Supported comment
 */</code></pre>
</div>
</div>
<div class="paragraph">
<p>Entre los tags JSDoc, destacan:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@returns {Type} Description</code></p>
</li>
<li>
<p><code>@param {Type} Name Description</code></p>
</li>
<li>
<p><code>@ignore</code> para excluir un fragmento de código de la documentación</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para instalar Compodoc en un proyecto NestJS basta con añadir el paquete:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm i -D @compodoc/compodoc</code></pre>
</div>
</div>
<div class="paragraph">
<p>La documentación se generará desde la línea de comandos mediante <code>npx</code> (una herramienta para ejecutar paquetes de Node disponible con <code>npm 6</code>). Esto generará una carpeta <code>documentation</code> en el proyecto que se podrá servir con el proyecto o en un portal de ámbito más global donde estén todas las documentaciones de los proyectos desarrollados por el equipo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npx compodoc -p tsconfig.json -s --theme material</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El parámetro <code>-s</code> inicia un servidor en el puerto 8080 para poder consultar la documentación. El parámetro <code>--theme material</code> aplica el tema <code>material</code> a la documentación. Para más información sobre las opciones de uso, consultar la <a href="https://compodoc.app/guides/options.html">documentación oficial</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Compodoc genera una página <code>Overview</code> donde presenta un diagrama con los disntintos componentes y sus relaciones, algo muy interesante para hacerse una primera idea de la composición e interacción del software desarrollado.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Compodoc-Overview.png" alt="Compodoc Overview">
</div>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra el formato de la documentación de un componente de la aplicación.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Compodoc-Documentacion.png" alt="Compodoc Documentacion">
</div>
</div>
<div class="paragraph">
<p>Para más información sobre JSDoc, consultar la <a href="https://compodoc.app/">documentación oficial</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueestado-de-salud"><a class="anchor" href="#trueestado-de-salud"></a>13. Estado de salud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un aspecto de interés a tener en cuenta al crear una aplicación consiste en ofrecer en una ruta concreta el estado de salud en el que se encuentra la aplicación y sus componentes (p.e. base de datos). Esto facilita el trabajo posterior a la herramientas de monitorización a la hora de recopilación de datos y de disparo de alertas. NestJS se integra con el paquete <a href="https://www.npmjs.com/package/@nestjs/terminus">Terminus</a>. Este paquete nos permite mostrar el estado HTTP de la aplicación en su conjunto, así como indicadores concretos del estado de otros componentes como TypeORM, Mongoose, Sequelize o indicadores de uso de disco y de memoria.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El estado de salud se suele exponer en la ruta <code>/health</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="trueconfiguración-inicial-del-estado-de-salud"><a class="anchor" href="#trueconfiguración-inicial-del-estado-de-salud"></a>13.1. Configuración inicial del estado de salud</h3>
<div class="paragraph">
<p>Comenzamos instalando el paquete <code>Terminus</code> con <code>npm</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm install --save @nestjs/terminus</code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación crearemos un módulo y un controlador <code>health</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ nest generate module health
$ nest generate controller health</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras esto, por un lado tenemos el módulo <code>health</code> en la zona de <code>imports</code> de <code>app.module.ts</code></p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>app.module.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { HealthModule } from './health/health.module';

@Module({
  imports: [
    ...
    HealthModule, <i class="conum" data-value="1"></i><b>(1)</b>
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Módulo <code>HealthModule</code> disponible para la aplicación</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>y por otro lado un módulo <code>HealthModule</code> que incluye al controlador <code>Health</code> creado. A continuación, añadiremos el módulo de <code>Terminus</code> en el módulo <code>HealthModule</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>health/health.module.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { HealthController } from './health.controller';
import { TerminusModule } from '@nestjs/terminus';

@Module({
  imports: [TerminusModule], <i class="conum" data-value="1"></i><b>(1)</b>
  controllers: [HealthController],
})
export class HealthModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadimos el módulo de Terminus en el módulo de <em>health</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por último, para completar la configuración inicial añadiremos una ruta en el controlador <code>health</code> para exponer el estado de salud de la API</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>health/health.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Controller, Get } from '@nestjs/common';
import {
  HealthCheckService,
  HealthCheck,
} from '@nestjs/terminus';

@Controller('health') <i class="conum" data-value="1"></i><b>(1)</b>
export class HealthController {
  constructor(
    private health: HealthCheckService, <i class="conum" data-value="2"></i><b>(2)</b>
  ) {}

  @Get()
  @HealthCheck() <i class="conum" data-value="3"></i><b>(3)</b>
  check() { <i class="conum" data-value="4"></i><b>(4)</b>
    return this.health.check([]); <i class="conum" data-value="5"></i><b>(5)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ruta en la que se sirve el estado de salud</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Servicio <code>HealthCheckService</code> de <code>Terminus</code> inyectado en el constructor</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Decorador <code>HealthCheck</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Método para devolver el estado de salud</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Método básico que devuelve si se ha iniciado la API</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora llamamos a la API en <code>/health</code> obtendremos la respuesta siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "status": "ok",
    "info": {},
    "error": {},
    "details": {}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>API disponible</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>No es demasiada información, pero con esto nada más ya sabemos que la API está disponible, tal y como indica el elemento <code>status</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="trueestado-de-salud-de-componentes"><a class="anchor" href="#trueestado-de-salud-de-componentes"></a>13.2. Estado de salud de componentes</h3>
<div class="paragraph">
<p>Terminus ofrece una serie de indicadores de salud interesantes. Entre los más interesantes, actualmente destacan los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HttpHealthIndicator</code></p>
</li>
<li>
<p><code>TypeOrmHealthIndicator</code></p>
</li>
<li>
<p><code>MemoryHealthIndicator</code></p>
</li>
<li>
<p><code>DiskHealthIndicator</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El uso de estos indicadores va a ofrecer información complementaria y más detallada del estado de la aplicación. Su uso consta de dos pasos a realizar en el controlador <code>health</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inyectar en el constructor el indicador deseado.</p>
</li>
<li>
<p>Añadir al array <code>health.check</code> una función anónima para cada prueba de salud a realizar en cada componente.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>También hay indicadores para conocer el estado de Mongoose y Sequelize. Para ello, se usan los indicadores <code>MongooseHealthIndicator</code> y <code>SequelizeHealthIndicator</code>, respectivamente.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El código siguiente muestra:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El uso de comprobación del estado de la base de datos.</p>
</li>
<li>
<p>Si se ha sobrepasado el límite de la memoria (<em>heap</em> y memoria residente) estimada para la aplicación (50 MB y 150 MB, respectivamente).</p>
</li>
<li>
<p>Si se está utilizando más del 75% del disco en la máquina en la que se está ejecutando la aplicación</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Controller, Get } from '@nestjs/common';
import { DiskHealthIndicator } from '@nestjs/terminus';
import {
  HealthCheckService,
  HealthCheck,
  TypeOrmHealthIndicator,
  MemoryHealthIndicator,
} from '@nestjs/terminus';

@Controller('health')
export class HealthController {
  constructor( <i class="conum" data-value="1"></i><b>(1)</b>
    private health: HealthCheckService,
    private dbIndicator: TypeOrmHealthIndicator,
    private memoryIndicator: MemoryHealthIndicator,
    private diskHealthIndicator: DiskHealthIndicator,
  ) {}

  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      () =&gt; this.dbIndicator.pingCheck('database'), <i class="conum" data-value="2"></i><b>(2)</b>
      () =&gt; this.memoryIndicator.checkHeap('heap', 50 * 1024 * 1024), // process &lt; 50MB <i class="conum" data-value="3"></i><b>(3)</b>
      () =&gt; this.memoryIndicator.checkRSS('memory', 150 * 1024 * 1024), // process &lt; 150MB <i class="conum" data-value="4"></i><b>(4)</b>
      () =&gt;
        this.diskHealthIndicator.checkStorage('disk &lt;5&gt; health', {
          thresholdPercent: 0.75,
          path: '/',
        }),
    ]);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inyección de servicios Terminus de indicación de salud</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Comprueba que la base de datos esté activa y admita conexiones</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Comprueba que el uso del heap está por debajo de 50 MB</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Comprueba que el uso de memoria residente está por debajo de 150 MB</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Comprueba que el uso del disco en la máquina en la que se ejecuta esta aplicación está por debajo del 75%</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si todos los indicadores devuelven <code>ok</code>, el <code>status</code> global es <code>ok</code>. Si alguno de los componentes no cumple la condición de check establecida, el <code>status</code> global de la aplicación pasa a ser <code>error</code>. Los componentes que funcionan correctamente se devuelven en el elemento <code>info</code>. En cambio, los componentes que presentan algún problema se devuelven en el elemento <code>error</code>.</p>
</div>
<div class="paragraph">
<p>Si consultamos las ruta <code>/health</code>, devuelve que el estado global es <code>ok</code> y que todos los componentes están <code>ok</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/statusOK.png" alt="statusOK">
</div>
</div>
<div class="paragraph">
<p>Para forzar un error, si reducimos la memoria RSS a un valor de 10 MB en lugar de los 150 MB anteriores, el estado de salud pasará a <code>error</code> y en el elemento <code>error</code> se creará una entrada para el elemento que presenta anomalías (<code>memory</code> en este caso).</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/statusError.png" alt="statusError"></span></p>
</div>
<div class="paragraph">
<p>Una vez definidas las pruebas de salud que queremos exponer de nuestra API e informamos del estado de cada uno de sus componentes, se facilita bastante el trabajo posterior a los sistemas de monitorización que se estén usando. Estos, periódicamente visitarán la ruta <code>/health</code>, recopilarán los datos para su posterior análisis y dispararán alguna alarma llegado el caso de que se produzca un error en algún componente.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Es posible construir indicadores de salud personalizados (p.e. <a href="https://wanago.io/2021/10/11/api-nestjs-health-checks-terminus-datadog/">chequear el estado de un servicio ElasticSearch asociado a nuestra API</a>)</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueactivación-de-métricas"><a class="anchor" href="#trueactivación-de-métricas"></a>14. Activación de métricas</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="truemétricas-de-forma-manual"><a class="anchor" href="#truemétricas-de-forma-manual"></a>14.1. Métricas de forma manual</h3>
<div class="paragraph">
<p>Para instalarlo, ejecutaremos desde la terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm install @willsoto/nestjs-prometheus prom-client</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras instalarlo, realizamos la configuración del cliente de Prometheus en <code>src/app.module.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import {
  makeCounterProvider,
  PrometheusModule,
} from '@willsoto/nestjs-prometheus'; <i class="conum" data-value="1"></i><b>(1)</b>

@Module({
  imports: [
    ...
    PrometheusModule.register(), <i class="conum" data-value="2"></i><b>(2)</b>
  ],
  ...
  providers: [
    ...
    makeCounterProvider({<i class="conum" data-value="3"></i><b>(3)</b>
      name: 'books_served',
      help: 'books_help',
    }),
  ],
})
export class AppModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación del paquete de Prometheus para NestJS</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Registro del módulo de Prometheus en el array <code>imports</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creación de un nuevo contador denominado <code>books_served</code> y con el texto de ayuda <code>books_help</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por último, en el método que actualizará la métrica en Prometheus, se incrementará en uno el contador de la métrica tras cada llamada al método.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { HttpStatus, Injectable } from '@nestjs/common';
import { InjectMetric } from '@willsoto/nestjs-prometheus'; <i class="conum" data-value="1"></i><b>(1)</b>
import { Counter } from 'prom-client'; <i class="conum" data-value="2"></i><b>(2)</b>

@Injectable()
export class BooksService {
  constructor(@InjectMetric('books_served') public counter: &lt;3&gt; Counter&lt;string&gt;) {}
  findAll(): any {
    this.counter.inc(); <i class="conum" data-value="4"></i><b>(4)</b>
    return {
      status: HttpStatus.OK,
      message: 'findAll funcionando',
    };
  }

  findOne(bookId: string): any {
    return {
      status: HttpStatus.OK,
      message: `findOne funcionando con ${bookId}`,
    };
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Imnportación del inyector de métricas</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Importación del objeto contador</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Inyectar la métrica <code>books_served</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Incrementar el contador en cada ejecución del método</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truemétricas-con-swagger-stats"><a class="anchor" href="#truemétricas-con-swagger-stats"></a>14.2. Métricas con <code>swagger-stats</code></h3>
<div class="paragraph">
<p><code>swagger-stats</code> es un middleware para telemetría de APIs. Permite recoger métricas de los endpoints de la API en cuanto a tiempos de resolución, payloads, códigos de estado HTTP de las respuestas, y demás. En su funcionamiento, detecta las operaciones a través de las rutas de la API.</p>
</div>
<div class="paragraph">
<p>Entre las caracterísitcas de <code>swagger-stats</code>, destacamos que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Expone las métricas en formato Prometheus por lo que se puede usar la combinación Prometheus-Grafana para monitorización y alertas. Disponer de estas métricas permitirá identificar errores, peticiones con tiempos elevados de ejecución, identificar los últimos erorres, identificar tendencias y demás operaciones de interés en la monitorización de una API.</p>
</li>
<li>
<p>Incorpora una interfaz de telemetría bastante avanzada de forma que permite comenzar a monitorizar una API si necesidad de instalar nada más de primeras.</p>
</li>
<li>
<p>Permite especificar un host Elasticsearch para el almacenamiento de los datos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para instalarlo, ejecutaremos desde la terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ nom install prom-client --save
$ npm install swagger-stats --save</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras instalarlo, basta con habilitarlo en <code>src/main.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import * as swStats from 'swagger-stats'; <i class="conum" data-value="1"></i><b>(1)</b>
...

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  ...
  app.use(swStats.getMiddleware({})); <i class="conum" data-value="2"></i><b>(2)</b>
  ...
}
bootstrap();
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importar <code>swagger-stats</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Habilitar el middleware <code>swagger-stats</code> en la API</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Configuración de <code>swagger-stats</code></div>
<div class="paragraph">
<p>Es posible configurar ciertos parámetros interesantes, como el nombre de la API, si se requiere autenticación y credenciales en tal caso, URL y credenciales de Elasticsearch, por citar una cuantas. Para más información, consultar la <a href="https://swaggerstats.io/guide/conf.html#options">documentación oficial</a>.</p>
</div>
<div class="paragraph">
<p>A continuación se muestra un ejemplo de configuración en el archivo <code>src/main.ts</code> con parámetros de interés para autenticación y uso de Elastisearch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  app.use(
    swStats.getMiddleware({
      name: 'api-catalog',
      authentication: true, <i class="conum" data-value="1"></i><b>(1)</b>
      onAuthenticate: function(req, username, password) { <i class="conum" data-value="2"></i><b>(2)</b>
        // simple check for username and password
        return username === 'admin' &amp;&amp; password === 'secret';
      },
      elasticsearch: 'http://myelastic.com:9200', <i class="conum" data-value="3"></i><b>(3)</b>
      elasticsearchUsername: 'admin', <i class="conum" data-value="4"></i><b>(4)</b>
      elasticsearchPassword: 'secret' <i class="conum" data-value="5"></i><b>(5)</b>
    }),
  );
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Activación de la autenticación</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Función callback para realizar la autenticación. Se especifica usuario y contraseña</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>URL de Elasticsearch</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Nombre de usuario de Elasticsearch</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Password de Elasticsearch</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En un entorno de producción, no dejar las credenciales directamente en el código. Se recomienda usar variables de entorno o cualquier otra técnica que no exponga directamente las credenciales.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>A continuación se muestra cómo luce <code>swagger-stats</code> tras varias interacciones con la API.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/swagger-stats-summary.png" alt="swagger stats summary">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/swagger-stats-requests.png" alt="swagger stats requests">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/swagger-stats-api.png" alt="swagger stats api">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/swagger-stats-rates-and-durations.png" alt="swagger stats rates and durations">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/swagger-stats-payload.png" alt="swagger stats payload">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/swagger-stats-last-errors.png" alt="swagger stats last errors">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/swagger-stats-longest-requests.png" alt="swagger stats longest requests">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueapéndice-a-datos-de-ejemplo"><a class="anchor" href="#trueapéndice-a-datos-de-ejemplo"></a>Apéndice A. Datos de ejemplo</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">[
  {
    "title": "Una historia de España",
    "genre": "Historia",
    "description": "Un relato ameno, personal, a ratos irónico, pero siempre único, de nuestra accidentada historia a través de los siglos. Una obra concebida por el autor para, en palabras suyas, «divertirme, releer y disfrutar; un pretexto para mirar atrás desde los tiempos remotos hasta el presente, reflexionar un poco sobre ello y contarlo por escrito de una manera poco ortodoxa.",
    "author": "Arturo Pérez-Reverte",
    "publisher": "Alfaguara",
    "pages": 256,
    "image_url": "https://images-na.ssl-images-amazon.com/images/I/41%2B-e981m1L._SX311_BO1,204,203,200_.jpg"
  },
  {
    "title": "Historia de España contada para escépticos",
    "genre": "Historia",
    "description": "Como escribe el autor, no pretende ser veraz, justa y desapasionada, porque ninguna historia lo es. No está hecha para halagar a reyes y gobernantes, ni pretende halagar a los banqueros, ni a la Conferencia Episcopal, ni al colectivo gay.",
    "author": "Juan Eslava Galán",
    "publisher": "Booket",
    "pages": 592,
    "image_url": "https://images-na.ssl-images-amazon.com/images/I/51IyZ5Mq8YL._SX326_BO1,204,203,200_.jpg",
    "__v": 0
  },
  {
    "title": "El enigma de la habitación 622",
    "genre": "Ficción contemporánea",
    "description": "Vuelve el «principito de la literatura negra contemporánea, el niño mimado de la industria literaria» (GQ): el nuevo thriller de Joël Dicker es su novela más personal. ",
    "author": "Joël Dicker",
    "publisher": "Alfaguara",
    "pages": 624,
    "image_url": "https://images-na.ssl-images-amazon.com/images/I/41KiZbwOhhL._SX315_BO1,204,203,200_.jpg"
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueapéndice-b-generación-de-código"><a class="anchor" href="#trueapéndice-b-generación-de-código"></a>Apéndice B. Generación de código</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A la hora de abordar un proyecto de backend hay tareas repetitivas que son susceptibles de ser sometidas a algún grado de automatización. Esto es algo deseable ya que de forma directa esto aumentará nuestra eficacia por un lado, y por otro reducirá la introducción de errores. Veamos aquí dos generadores de código útiles.</p>
</div>
<div class="sect2">
<h3 id="truegenerador-de-archivos-para-una-entidad"><a class="anchor" href="#truegenerador-de-archivos-para-una-entidad"></a>Generador de archivos para una entidad</h3>
<div class="paragraph">
<p>Normalmente, para cada entidad de nuestro proyecto de backend tendremos que crear un módulo, un controlador, un servicio, una clase para la entidad y algunos DTO (p.e. el de crear y el de modificar). Todos estos archivos pueden ser generados de forma automática por el CLI de NestJS generando lo que se denomina un <em>recurso</em>. Desde la carpeta del proyecto ejecutaremos el comando siguiente para cada <em>recurso</em> que queramos crear.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ nest generate resource &lt;nombre-recurso&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>En primer lugar nos pedirá el tipo de nivel de transporte que queremos usar. Elegiremos <code>REST API</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">? What transport layer do you use? (Use arrow keys)
❯ REST API
  GraphQL (code first)
  GraphQL (schema first)
  Microservice (non-HTTP)
  WebSockets</code></pre>
</div>
</div>
<div class="paragraph">
<p>En segundo lugar aceptaremos la generación de los endpoints básicos para las operaciones CRUD.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">? Would you like to generate CRUD entry points? (Y/n)</code></pre>
</div>
</div>
<div class="paragraph">
<p>En el caso de que hayamos elegido crear los recursos para <code>users</code> se crearán los archivos siguientes y se actualizará <code>src/app.module.ts</code> para añadir el módulo del recurso creado (p.e. <code>users.module</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">CREATE src/users/users.controller.spec.ts (566 bytes)
CREATE src/users/users.controller.ts (890 bytes)
CREATE src/users/users.module.ts (247 bytes)
CREATE src/users/users.service.spec.ts (453 bytes)
CREATE src/users/users.service.ts (609 bytes)
CREATE src/users/dto/create-user.dto.ts (30 bytes)
CREATE src/users/dto/update-user.dto.ts (169 bytes)
CREATE src/users/entities/user.entity.ts (21 bytes)
UPDATE src/app.module.ts (312 bytes)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Archivo <code>users.controller.ts</code> creado</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="typescript" class="language-typescript hljs">import { Controller, Get, Post, Body, Put, Param, Delete } from '@nestjs/common';
import { UsersService } from './users.service';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';

@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Post()
  create(@Body() createUserDto: CreateUserDto) {
    return this.usersService.create(createUserDto);
  }

  @Get()
  findAll() {
    return this.usersService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.usersService.findOne(+id);
  }

  @Put(':id')
  update(@Param('id') id: string, @Body() updateUserDto: UpdateUserDto) {
    return this.usersService.update(+id, updateUserDto);
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.usersService.remove(+id);
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Archivo <code>users.service.ts</code> creado</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="typescript" class="language-typescript hljs">import { Injectable } from '@nestjs/common';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';

@Injectable()
export class UsersService {
  create(createUserDto: CreateUserDto) {
    return 'This action adds a new user';
  }

  findAll() {
    return `This action returns all users`;
  }

  findOne(id: number) {
    return `This action returns a #${id} user`;
  }

  update(id: number, updateUserDto: UpdateUserDto) {
    return `This action updates a #${id} user`;
  }

  remove(id: number) {
    return `This action removes a #${id} user`;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Voilà!! A partir de los archivos generados ya se pueden adaptar los endpoints del controlador, crear el código de los servicios y adaptar las entidades y los DTOs al caso de base de datos del proyecto.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Más información sobre <code>CRUD generator</code> en la <a href="https://docs.nestjs.com/recipes/crud-generator">documentación oficial</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truegenerador-del-código-de-la-entidad"><a class="anchor" href="#truegenerador-del-código-de-la-entidad"></a>Generador del código de la entidad</h3>
<div class="paragraph">
<p><code>typeorm-model-generator</code> es un paquete NodeJS para trabajar con TypeORM que genera los modelos a partir de las tablas existentes en una base de datos. Actualmente soporta los siguientes DBMS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Microsoft SQL Server</p>
</li>
<li>
<p>PostgreSQL</p>
</li>
<li>
<p>MySQL</p>
</li>
<li>
<p>MariaDB</p>
</li>
<li>
<p>Oracle Database</p>
</li>
<li>
<p>SQLite</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>typeorm-model-generator</code> incorpora el driver para todas las bases de datos soportadas excepto para Oracle. Para Oracle se debe tener instalado Oracle Instant Client en el equipo donde se vaya a ejecutar <code>typeorm-model-generator</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>typeorm-model-generator</code> se podrá invocar directamente mediante <a href="https://www.npmjs.com/package/npx"><code>npx</code></a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>npx</code> es una herramienta que permite ejecutar paquetes de binarios <code>npm</code>. <code>npx</code> queda instalado en versiones posteriores a <code>npm 5.2</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación se muestran unos parámetros habituales que utilizaremos al generar los modelos con <code>typeorm-model-generator</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-h</code>: Host de la base de datos</p>
</li>
<li>
<p><code>-d</code>: Nombre de la base de datos</p>
</li>
<li>
<p><code>-u</code>: Usuario</p>
</li>
<li>
<p><code>-x</code>: Contraseña</p>
</li>
<li>
<p><code>-e</code>: DBMS (p.e. <code>mysql, oracle, mssql, pgsql</code>, &#8230;&#8203;)</p>
</li>
<li>
<p><code>-o</code>: (opcional) Ruta en la que guardar los archivos generados</p>
</li>
<li>
<p><code>-p</code>: (opcional) Puerto</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A continuación se muestra un ejemplo de uso en Oracle</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npx typeorm-model-generator -h localhost -d myDatabase -u myUser -x myPassword -e oracle -o ./reservations -p 1527</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto generará un archivo de entidad para cada tabla encontrada en la base de datos indicada incluyendo la definición de cada uno de los campos de la tabla.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Usa los archivos generados para adaptar el contenido de los archivos de entidades generados con <em>CRUD generator</em> del apartado anterior <a href="#truegenerador-de-archivos-para-una-entidad">Generador de archivos para una entidad</a>.</p>
</div>
<div class="paragraph">
<p>Los archivos generados por <code>typeorm-model-generator</code> también se pueden usar para personalizar los DTO generados por <em>CRUD generator</em>. Para adaptar los DTOs normalmente quitaremos algunos de los campos de los modelos creados por <em>CRUD generator</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación se muestra un ejemplo de archivo creado por ``</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="typescript" class="language-typescript hljs">import { Column, Entity, Index, JoinColumn, ManyToOne } from "typeorm";
import { RstCalendarios } from "./RstCalendarios";

@Index("RST_DIAS_PK", ["yDia"], { unique: true })
@Entity("RST_DIAS") <i class="conum" data-value="1"></i><b>(1)</b>
export class RstDias {
  @Column("varchar2", { name: "T_OBSERVACIONES", nullable: true, length: 100 }) <i class="conum" data-value="2"></i><b>(2)</b>
  tObservaciones: string | null;

  @Column("varchar2", { name: "L_RESERVABLE", nullable: true, length: 1 })
  lReservable: string | null;

  @Column("date", { name: "F_CALENDARIO", nullable: true })
  fCalendario: Date | null;

  @Column("number", { primary: true, name: "Y_DIA" })
  yDia: number;

  @ManyToOne(() =&gt; RstCalendarios, (rstCalendarios) =&gt; rstCalendarios.rstDias) <i class="conum" data-value="3"></i><b>(3)</b>
  @JoinColumn([{ name: "Y_CALENDARIO", referencedColumnName: "yCalendario" }])
  yCalendario: RstCalendarios;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Entidad con el nombre de la tabla con la que se corresponde</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición de cada una de las columnas con sus tipos de datos, restricciones, &#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Anotaciones para relaciones</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-11-30 21:17:19 +0100
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>